<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Aromes De Dieu</title>
      <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@200;300;400;500;600&family=Italiana&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Librer√≠as para QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
      <!-- CSS del panel -->
    <link rel="stylesheet" href="../css/admin-panel.css">
    <link rel="stylesheet" href="../css/admin-panel-validacion.css">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <h1>Panel de Administraci√≥n</h1>
            <p>Gesti√≥n completa de productos y categor√≠as - Aromes De Dieu</p>
        </header>

        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <nav>
                <ul class="sidebar-menu">
                    <li>
                        <a href="#dashboard" class="active">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#productos">
                            <i class="fas fa-box"></i>
                            Productos
                        </a>
                    </li>
                    <li>
                        <a href="#agregar-producto">
                            <i class="fas fa-plus"></i>
                            Agregar Producto
                        </a>
                    </li>
                    <li>
                        <a href="#categorias">
                            <i class="fas fa-tags"></i>
                            Categor√≠as
                        </a>
                    </li>
                    <li>
                        <a href="#generador-qr">
                            <i class="fas fa-qrcode"></i>
                            Generador QR
                        </a>
                    </li>
                    <li>
                        <a href="#configuracion">
                            <i class="fas fa-cog"></i>
                            Configuraci√≥n
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Contenido principal -->
        <main class="admin-content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section active">
                <h2 class="section-title">Dashboard</h2>
                
                <div class="dashboard-grid">
                    <div class="dashboard-card" data-card="total-productos">
                        <h3>Total Productos</h3>
                        <div class="number">0</div>
                        <div class="description">Productos en la base de datos</div>
                    </div>
                    
                    <div class="dashboard-card" data-card="productos-activos">
                        <h3>Productos Activos</h3>
                        <div class="number">0</div>
                        <div class="description">Productos visibles en la tienda</div>
                    </div>
                    
                    <div class="dashboard-card" data-card="total-categorias">
                        <h3>Categor√≠as</h3>
                        <div class="number">0</div>
                        <div class="description">Categor√≠as disponibles</div>
                    </div>
                    
                    <div class="dashboard-card" data-card="total-marcas">
                        <h3>Marcas</h3>
                        <div class="number">0</div>
                        <div class="description">Marcas representadas</div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <button id="refreshData" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar Datos
                    </button>
                    
                    <!-- Botones de debug -->
                    <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                        <h4>üîß Herramientas de Debug</h4>
                        <button onclick="debugPanel()" class="btn btn-secondary" style="margin: 5px;">
                            üîç Debug Panel
                        </button>
                        <button onclick="forceReloadProducts()" class="btn btn-secondary" style="margin: 5px;">
                            üîÑ Forzar Recarga Productos
                        </button>
                        <button onclick="testSupabaseConnection()" class="btn btn-secondary" style="margin: 5px;">
                            üì° Test Supabase
                        </button>                        <button onclick="showAllSections()" class="btn btn-secondary" style="margin: 5px;">
                            üìÑ Mostrar Todas las Secciones
                        </button>
                        <button onclick="testSaveProduct()" class="btn btn-secondary" style="margin: 5px;">
                            üíæ Test Guardar Producto
                        </button>                        <button onclick="testDirectSupabase()" class="btn btn-secondary" style="margin: 5px;">
                            üîó Test Supabase Directo
                        </button>
                        <button onclick="testImageUpload()" class="btn btn-secondary" style="margin: 5px;">
                            üì∑ Test Subida Imagen
                        </button>
                        <button onclick="testImageUpload()" class="btn btn-secondary" style="margin: 5px;">
                            üñºÔ∏è Test Subida Imagen
                        </button>
                        <div id="debugOutput" style="margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </section>            <!-- Productos -->
            <section id="productos" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Productos</h2>
                    <button id="refreshProducts" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i>
                        Recargar Productos
                    </button>
                </div>
                
                <div class="products-controls">
                    <input type="text" id="searchProducts" placeholder="Buscar productos..." class="form-control">
                </div>
                
                <div class="products-grid">
                    <!-- Los productos se cargar√°n din√°micamente aqu√≠ -->
                </div>
            </section>

            <!-- Agregar Producto -->
            <section id="agregar-producto" class="content-section">
                <h2 class="section-title">Agregar Nuevo Producto</h2>
                
                <form id="productForm" class="product-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nombre">Nombre del Producto *</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="marca">Marca *</label>
                            <input type="text" id="marca" name="marca" required>
                        </div>
                          <div class="form-group">                            <label for="precio">Precio (COP) *</label>                            <input type="number" id="precio" name="precio" required step="1000" min="0" max="2147483647" 
                                   placeholder="Ej: 50000" 
                                   oninput="adminPanel.validatePrice(this)">
                        </div>
                        
                        <div class="form-group">
                            <label for="ml">Tama√±o (ML) *</label>
                            <input type="number" id="ml" name="ml" required min="1" max="1000" 
                                   placeholder="Ej: 100" value="100">
                            <div class="help-text">Tama√±o del producto en mililitros</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="categoria">Categor√≠a *</label>
                            <select id="categoria" name="categoria" required>
                                <option value="">Seleccionar categor√≠a</option>
                                <option value="para-ellos">Para Ellos</option>
                                <option value="para-ellas">Para Ellas</option>
                                <option value="unisex">Unisex</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="subcategoria">Subcategor√≠a</label>
                            <select id="subcategoria" name="subcategoria">
                                <option value="">Seleccionar subcategor√≠a</option>
                                <option value="designer">Marcas de Dise√±ador</option>
                                <option value="arabic">Marcas √Årabes</option>
                                <option value="contemporary">Perfumer√≠a Contempor√°nea</option>
                                <option value="vintage">Vintage</option>
                            </select>                        </div>
                        
                    </div>
                    
                    <!-- Secci√≥n de Imagen como apartado independiente -->
                    <div class="image-upload-section">
                        <h3 class="section-title">
                            <i class="fas fa-image"></i>
                            Imagen del Producto (URL)
                        </h3>
                        
                        <div class="image-upload-container">
                            <div class="input-group">
                                <input type="url" id="imagen_url" name="imagen_url" placeholder="https://images.unsplash.com/photo-1234567890/image.jpg" class="form-control" required>
                                <button type="button" class="btn btn-secondary" onclick="adminPanel.previewImageFromUrl()">
                                    <i class="fas fa-eye"></i> Vista Previa
                                </button>
                            </div>
                            <div class="help-text">
                                <strong>Usa URLs directas de im√°genes.</strong> Ejemplos:
                                <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                                    <li>Unsplash: https://images.unsplash.com/photo-xxxxx?w=400&h=400</li>
                                    <li>Pexels: https://images.pexels.com/photos/xxxxx/image.jpg?w=400&h=400</li>
                                    <li>Directa: https://tu-dominio.com/imagen.jpg</li>
                                </ul>
                            </div>
                            
                            <div class="quick-images">
                                <div class="quick-images-title">
                                    <i class="fas fa-images"></i> Im√°genes de Ejemplo (Clic para usar):
                                </div>
                                <div class="quick-images-grid">
                                    <div class="quick-image" onclick="adminPanel.useQuickImage('https://images.unsplash.com/photo-1541643600914-78b084683601?w=400&h=400&fit=crop')">
                                        <img src="https://images.unsplash.com/photo-1541643600914-78b084683601?w=100&h=100&fit=crop" alt="Perfume 1">
                                    </div>
                                    <div class="quick-image" onclick="adminPanel.useQuickImage('https://images.unsplash.com/photo-1523293182086-7651a899d37f?w=400&h=400&fit=crop')">
                                        <img src="https://images.unsplash.com/photo-1523293182086-7651a899d37f?w=100&h=100&fit=crop" alt="Perfume 2">
                                    </div>
                                    <div class="quick-image" onclick="adminPanel.useQuickImage('https://images.unsplash.com/photo-1594035910387-fea47794261f?w=400&h=400&fit=crop')">
                                        <img src="https://images.unsplash.com/photo-1594035910387-fea47794261f?w=100&h=100&fit=crop" alt="Perfume 3">
                                    </div>
                                    <div class="quick-image" onclick="adminPanel.useQuickImage('https://images.unsplash.com/photo-1595425970377-c9703cf48b6d?w=400&h=400&fit=crop')">
                                        <img src="https://images.unsplash.com/photo-1595425970377-c9703cf48b6d?w=100&h=100&fit=crop" alt="Perfume 4">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="image-preview" id="imagePreview" style="display: none;">
                                <div class="preview-header">
                                    <span><i class="fas fa-eye"></i> Vista previa:</span>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="adminPanel.clearImagePreview()">
                                        <i class="fas fa-times"></i> Limpiar
                                    </button>
                                </div>
                                <img id="previewImg" src="" alt="Vista previa" class="preview-image">
                            </div>
                        </div>
                    </div>
                      <!-- Descripci√≥n y Notas -->
                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n del Producto</label>
                        <textarea id="descripcion" name="descripcion" rows="3" placeholder="Descripci√≥n detallada del producto que aparecer√° en las tarjetas"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notas">Notas Olfativas</label>
                        <textarea id="notas" name="notas" rows="3" placeholder="Ej: Bergamota, Rosa, S√°ndalo (separadas por comas)"></textarea>
                    </div>
                      <div class="form-group">
                        <label for="estado">Estado del Producto *</label>                        <select id="estado" name="estado" required onchange="adminPanel.handleEstadoChange()">
                            <option value="disponible">Disponible</option>
                            <option value="agotado">Agotado</option>
                            <option value="proximo">Disponible Pr√≥ximamente</option>
                            <option value="oferta">En Oferta</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="descuentoGroup" style="display: none;">
                        <label for="descuento">Descuento (%) *</label>                        <input type="number" id="descuento" name="descuento" min="1" max="99" step="1" 
                               placeholder="Ej: 15" oninput="adminPanel.updatePrecioConDescuento()">
                        <div class="help-text">Porcentaje de descuento sobre el precio original</div>
                        <div class="precio-info" id="precioInfo" style="display: none;">
                            <small>Precio original: <span id="precioOriginal">$0</span></small><br>
                            <small>Precio con descuento: <span id="precioConDescuento">$0</span></small>
                        </div>
                    </div>
                      <div class="form-group">
                        <label>
                            <input type="checkbox" id="luxury" name="luxury">
                            Producto de lujo (mostrar√° la etiqueta LUXURY)
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="activo" name="activo" checked>
                            Producto activo (visible en la tienda)
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Guardar Producto
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-undo"></i>
                            Limpiar Formulario
                        </button>
                    </div>
                </form>
            </section>

            <!-- Categor√≠as -->
            <section id="categorias" class="content-section">
                <h2 class="section-title">Gesti√≥n de Categor√≠as</h2>
                
                <div class="categories-list">
                    <!-- Las categor√≠as se cargar√°n din√°micamente aqu√≠ -->
                </div>
            </section>

            <!-- Generador QR -->
            <section id="generador-qr" class="content-section">
                <h2 class="section-title">Generador de C√≥digos QR</h2>
                
                <!-- Estad√≠sticas QR -->
                <div class="dashboard-grid" style="margin-bottom: 2rem;">
                    <div class="dashboard-card">
                        <h3>Total QRs</h3>
                        <div class="number" id="total-qrs">0</div>
                        <div class="description">C√≥digos generados</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>QRs Escaneados</h3>
                        <div class="number" id="qrs-escaneados">0</div>
                        <div class="description">C√≥digos verificados</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Hoy</h3>
                        <div class="number" id="qrs-hoy">0</div>
                        <div class="description">QRs generados hoy</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Esta Semana</h3>
                        <div class="number" id="qrs-semana">0</div>
                        <div class="description">QRs generados</div>
                    </div>
                </div>

                <!-- Formulario de generaci√≥n -->
                <div class="qr-generator">
                    <form id="qrGeneratorForm" class="qr-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="qr-producto">Producto *</label>
                                <select id="qr-producto" name="producto" required>
                                    <option value="">Seleccionar producto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="qr-lote">Lote</label>
                                <input type="text" id="qr-lote" name="lote" placeholder="Ej: L2025001">
                            </div>
                            <div class="form-group">
                                <label for="qr-fecha">Fecha de Producci√≥n</label>
                                <input type="date" id="qr-fecha" name="fecha_produccion">
                            </div>
                            <div class="form-group">
                                <label for="qr-cantidad">Cantidad</label>
                                <input type="number" id="qr-cantidad" name="cantidad" value="1" min="1" max="100">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="qr-notas">Notas</label>
                            <textarea id="qr-notas" name="notas" rows="3" placeholder="Notas adicionales sobre este QR"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-qrcode"></i>
                            Generar QR
                        </button>
                    </form>
                </div>

                <!-- Resultado del QR -->
                <div id="qrResult" class="qr-result" style="display: none;">
                    <h3>QR Generado Exitosamente</h3>
                    <div class="qr-display">
                        <div class="qr-canvas-container">
                            <canvas id="qrCanvas"></canvas>
                        </div>
                        <div class="qr-info">
                            <h4>Informaci√≥n del QR</h4>
                            <p><strong>Producto:</strong> <span id="qr-producto-nombre">-</span></p>
                            <p><strong>Marca:</strong> <span id="qr-producto-marca">-</span></p>
                            <p><strong>C√≥digo:</strong> <code id="qr-codigo-id">-</code></p>
                            <p><strong>URL:</strong></p>
                            <div class="input-group">
                                <input type="text" id="qr-url" readonly class="form-control">
                                <button type="button" class="btn btn-secondary" onclick="adminPanel.copyQRUrl()">
                                    <i class="fas fa-copy"></i> Copiar
                                </button>
                            </div>
                            <div class="qr-actions">
                                <button onclick="adminPanel.downloadQR('png')" class="btn btn-success">
                                    <i class="fas fa-download"></i> PNG
                                </button>
                                <button onclick="adminPanel.downloadQR('svg')" class="btn btn-info">
                                    <i class="fas fa-vector-square"></i> SVG
                                </button>
                                <button onclick="adminPanel.printQR()" class="btn btn-secondary">
                                    <i class="fas fa-print"></i> Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial de QRs -->
                <div class="qr-history">
                    <h3>Historial de QRs</h3>
                    <div class="table-container">
                        <table class="qr-table">
                            <thead>
                                <tr>
                                    <th>QR</th>
                                    <th>Producto</th>
                                    <th>C√≥digo</th>
                                    <th>Lote</th>
                                    <th>Fecha Creaci√≥n</th>
                                    <th>Escaneado</th>
                                    <th>√öltima Verificaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="qrHistoryTable">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando historial...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Configuraci√≥n -->
            <section id="configuracion" class="content-section">
                <h2 class="section-title">Configuraci√≥n del Sistema</h2>
                
                <div class="config-section">
                    <h3>Configuraci√≥n de Supabase</h3>
                    <p>URL: <code>https://xelobsbzytdxrrxgmlta.supabase.co</code></p>
                    <p>Estado de conexi√≥n: <span id="connection-status">Verificando...</span></p>
                </div>
                
                <div class="config-section">
                    <h3>Herramientas de Base de Datos</h3>
                    <button class="btn btn-secondary" onclick="adminPanel.testConnection()">
                        <i class="fas fa-database"></i>
                        Probar Conexi√≥n
                    </button>
                    <button class="btn btn-primary" onclick="adminPanel.refreshAllData()">
                        <i class="fas fa-sync-alt"></i>
                        Sincronizar Datos
                    </button>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>    </div>
    
    <!-- Scripts en orden correcto -->
    <script>
        // Alias para compatibilidad con el c√≥digo
        window.QRCodeLib = window.QRCode || window.qrcode;
    </script>
    <script src="../js/supabase-config-optimized.js"></script>
    <script src="../js/qr-service-fixed.js"></script>
    <script src="../js/admin-panel-mejorado.js"></script>
    
    <!-- Configuraci√≥n de precios -->
    <script>
        // Configurar formato de precios
        function setupPriceFormatting() {
            const priceInput = document.getElementById('precio');
            if (!priceInput) return;
            
            priceInput.addEventListener('input', function(e) {
                formatPriceInput(e.target);
            });
            
            priceInput.addEventListener('blur', function(e) {
                formatPriceInput(e.target);
            });
        }
        
        function formatPriceInput(input) {
            let value = parseFloat(input.value.replace(/[^0-9.]/g, ''));
            
            if (isNaN(value)) {
                input.value = '';
                return;
            }
            
            const max = 10000000;
            if (value > max) {
                input.value = max;
                if (window.adminPanel) {
                    adminPanel.showAlert(`Precio ajustado al m√°ximo permitido: $${new Intl.NumberFormat('es-CO').format(max)}`, 'warning');
                }
            }
            
            if (value < 0) {
                input.value = 0;
            }
        }
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            setupPriceFormatting();
        });
    </script>
    
    <!-- Inicializaci√≥n del panel -->
    <script>
        let adminPanel;
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOM cargado, inicializando panel...');
            
            // Esperar un poco para asegurar que los scripts se ejecuten
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Verificar dependencias
            console.log('üîç Verificando dependencias...');
            console.log('Supabase:', typeof window.supabase !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('initSupabase:', typeof initSupabase === 'function' ? '‚úÖ' : '‚ùå');
            console.log('ProductosService:', typeof ProductosService !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('AdminPanel:', typeof AdminPanel !== 'undefined' ? '‚úÖ' : '‚ùå');
              // Crear instancia del panel admin
            if (typeof AdminPanel !== 'undefined') {
                try {
                    console.log('üìã Creando instancia del panel...');
                    adminPanel = new AdminPanel();
                    console.log('‚úÖ Panel de administraci√≥n listo');
                } catch (error) {
                    console.error('‚ùå Error creando panel:', error);
                    alert('Error inicializando el panel: ' + error.message);
                }
            } else {
                console.error('‚ùå AdminPanel no est√° disponible');
                alert('Error: La clase AdminPanel no est√° disponible. Verifica que admin-panel-mejorado.js se haya cargado correctamente.');
            }
        });
        
        // Funciones de debug globales
        window.debugPanel = function() {
            const output = document.getElementById('debugOutput');
            let debug = '';
            
            debug += `üìã Panel Admin Status:\n`;
            debug += `- AdminPanel class: ${typeof AdminPanel !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            debug += `- adminPanel instance: ${typeof adminPanel !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            debug += `- Current section: ${adminPanel ? adminPanel.currentSection : 'N/A'}\n`;
            debug += `- Products loaded: ${adminPanel ? adminPanel.productos.length : 0}\n`;
            debug += `- Categories loaded: ${adminPanel ? adminPanel.categorias.length : 0}\n`;
            debug += `- Brands loaded: ${adminPanel ? adminPanel.marcas.length : 0}\n\n`;
            
            debug += `üîß Dependencies:\n`;
            debug += `- Supabase: ${typeof window.supabase !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            debug += `- supabaseClient: ${typeof supabaseClient !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            debug += `- ProductosService: ${typeof ProductosService !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            debug += `- initSupabase: ${typeof initSupabase === 'function' ? '‚úÖ' : '‚ùå'}\n\n`;
            
            debug += `üìÑ DOM Elements:\n`;
            debug += `- products-grid: ${document.querySelector('.products-grid') ? '‚úÖ' : '‚ùå'}\n`;
            debug += `- sidebar-menu links: ${document.querySelectorAll('.sidebar-menu a').length}\n`;
            debug += `- content-sections: ${document.querySelectorAll('.content-section').length}\n`;
            
            if (output) {
                output.textContent = debug;
            }
            console.log('üîç Debug Panel:\n', debug);
        };
        
        window.forceReloadProducts = async function() {
            const output = document.getElementById('debugOutput');
            if (output) output.textContent = 'Recargando productos...\n';
            
            try {
                if (adminPanel) {
                    await adminPanel.reloadProducts();
                    if (output) output.textContent += 'Productos recargados exitosamente.\n';
                } else {
                    if (output) output.textContent += 'ERROR: adminPanel no disponible.\n';
                }
            } catch (error) {
                if (output) output.textContent += `ERROR: ${error.message}\n`;
                console.error('Error recargando productos:', error);
            }
        };
        
        window.testSupabaseConnection = async function() {
            const output = document.getElementById('debugOutput');
            if (output) output.textContent = 'Probando conexi√≥n Supabase...\n';
            
            try {
                if (typeof ProductosService !== 'undefined') {
                    const productos = await ProductosService.obtenerProductos();
                    if (output) output.textContent += `‚úÖ Conexi√≥n exitosa: ${productos.length} productos encontrados.\n`;
                } else {
                    if (output) output.textContent += 'ERROR: ProductosService no disponible.\n';
                }
            } catch (error) {
                if (output) output.textContent += `ERROR: ${error.message}\n`;
                console.error('Error probando conexi√≥n:', error);
            }
        };
        
        window.showAllSections = function() {
            const output = document.getElementById('debugOutput');
            const sections = document.querySelectorAll('.content-section');
            let debug = `üìÑ Secciones encontradas (${sections.length}):\n`;
            
            sections.forEach((section, index) => {
                debug += `${index + 1}. ${section.id} - ${section.classList.contains('active') ? 'ACTIVA' : 'inactiva'}\n`;
            });
            
            if (output) output.textContent = debug;
            console.log(debug);
        };
        
        window.testSaveProduct = async function() {
            const output = document.getElementById('debugOutput');
            if (output) output.textContent = 'Probando guardado de producto...\n';
            
            try {
                // Datos de prueba m√≠nimos
                const testProduct = {
                    nombre: 'Producto Test ' + new Date().getTime(),
                    marca: 'Test Brand',
                    precio: 50000,
                    categoria: 'para-ellos',
                    descripcion: 'Producto de prueba',
                    activo: true
                };
                
                if (output) output.textContent += 'Datos de prueba preparados...\n';
                console.log('üß™ Datos de prueba:', testProduct);
                
                if (adminPanel && typeof adminPanel.saveProduct === 'function') {
                    const result = await adminPanel.saveProduct(testProduct);
                    if (output) output.textContent += `‚úÖ Producto guardado exitosamente: ID ${result.id}\n`;
                    console.log('‚úÖ Test exitoso:', result);
                } else {
                    if (output) output.textContent += 'ERROR: adminPanel.saveProduct no disponible.\n';
                }
                
            } catch (error) {
                if (output) output.textContent += `ERROR: ${error.message}\n`;
                console.error('‚ùå Error en test:', error);
            }
        };
        
        window.testDirectSupabase = async function() {
            const output = document.getElementById('debugOutput');
            if (output) output.textContent = 'Probando Supabase directamente...\n';
            
            try {
                if (typeof supabaseClient === 'undefined' || !supabaseClient) {
                    if (output) output.textContent += 'ERROR: supabaseClient no disponible.\n';
                    return;
                }
                
                // Test de lectura
                const { data: readData, error: readError } = await supabaseClient
                    .from('productos')
                    .select('id, nombre')
                    .limit(3);
                    
                if (readError) {
                    if (output) output.textContent += `ERROR leyendo: ${readError.message}\n`;
                    return;
                }
                
                if (output) output.textContent += `‚úÖ Lectura OK: ${readData.length} productos\n`;
                
                // Test de escritura
                const testData = {
                    nombre: 'Test Direct ' + new Date().getTime(),
                    marca: 'Direct Brand',
                    precio: 25000,
                    categoria: 'para-ellos'
                };
                
                const { data: writeData, error: writeError } = await supabaseClient
                    .from('productos')
                    .insert([testData])
                    .select()
                    .single();
                    
                if (writeError) {
                    if (output) output.textContent += `ERROR escribiendo: ${writeError.message}\n`;
                    return;
                }
                
                if (output) output.textContent += `‚úÖ Escritura OK: ID ${writeData.id}\n`;
                
            } catch (error) {
                if (output) output.textContent += `ERROR: ${error.message}\n`;
                console.error('‚ùå Error en test directo:', error);
            }
        };
        
        window.testImageUpload = async function() {
            const output = document.getElementById('debugOutput');
            if (output) output.textContent = 'Probando subida de imagen...\n';
            
            try {
                // Verificar que ImageStorageService est√© disponible
                if (typeof ImageStorageService === 'undefined') {
                    if (output) output.textContent += 'ERROR: ImageStorageService no disponible.\n';
                    return;
                }
                
                // Crear una imagen de prueba (1x1 pixel transparente PNG)
                const testImageData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                
                if (output) output.textContent += 'Creando imagen de prueba...\n';
                
                // Convertir a blob y luego a file
                const response = await fetch(testImageData);
                const blob = await response.blob();
                const testFile = new File([blob], 'test-image.png', { type: 'image/png' });
                
                if (output) output.textContent += `Archivo creado: ${testFile.name} (${testFile.size} bytes)\n`;
                
                // Probar subida
                if (output) output.textContent += 'Subiendo imagen al storage...\n';
                const imageUrl = await ImageStorageService.uploadImage(testFile, 'test-upload');
                
                if (output) output.textContent += `‚úÖ Imagen subida exitosamente: ${imageUrl}\n`;
                
                // Opcional: eliminar imagen de prueba
                if (output) output.textContent += 'Eliminando imagen de prueba...\n';
                await ImageStorageService.deleteImage(imageUrl);
                if (output) output.textContent += '‚úÖ Imagen de prueba eliminada.\n';
                
            } catch (error) {
                if (output) output.textContent += `ERROR: ${error.message}\n`;
                console.error('‚ùå Error en test de imagen:', error);
            }
        };
        
        // Funciones globales para eventos del formulario
        window.handleEstadoChange = function() {
            if (window.adminPanel) {
                adminPanel.handleEstadoChange();
            }
        };
        
        window.updatePrecioConDescuento = function() {
            if (window.adminPanel) {
                adminPanel.updatePrecioConDescuento();
            }
        };
        
        window.previewImageFromUrl = function() {
            if (window.adminPanel) {
                adminPanel.previewImageFromUrl();
            }
        };
        
        window.previewImageFromFile = function(input) {
            if (window.adminPanel) {
                adminPanel.previewImageFromFile(input);
            }
        };
          window.clearImagePreview = function() {
            if (window.adminPanel) {
                adminPanel.clearImagePreview(true); // Limpiar todo cuando el usuario hace click en limpiar
            }
        };
    </script>
    
    <!-- Configuraci√≥n de precios -->
    <script>
        // Funci√≥n para cambiar tabs de imagen
        window.switchImageTab = function(tabType) {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');
            
            // Actualizar tabs
            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabType);
            });
            
            // Actualizar contenido
            contents.forEach(content => {
                content.classList.toggle('active', content.id === `${tabType}-tab`);
            });
            
            // Actualizar tipo en adminPanel
            if (window.adminPanel) {
                adminPanel.imageType = tabType;
            }
        };
        
        // Funci√≥n para validar precio en tiempo real
        window.validatePrice = function(input) {
            const value = parseInt(input.value);
            const max = 2147483647; // L√≠mite de PostgreSQL int
            
            if (value > max) {
                input.value = max;
                if (window.adminPanel) {
                    adminPanel.showAlert(`Precio ajustado al m√°ximo permitido: $${new Intl.NumberFormat('es-CO').format(max)}`, 'warning');
                }
            }
            
            if (value < 0) {
                input.value = 0;
            }
        };
    </script>
</body>
</html>
