// ==========================================
// VERIFICADOR R√ÅPIDO: SINCRONIZACI√ìN DEL CARRITO
// ==========================================

(function() {
    'use strict';

    // Crear verificador global
    window.verificarCarrito = function() {
        console.log('\nüîç VERIFICACI√ìN R√ÅPIDA DEL CARRITO');
        console.log('‚ïê'.repeat(50));
        
        const resultados = {
            sistema: false,
            agregar: false,
            sincronizacion: false,
            persistencia: false,
            errores: []
        };

        try {
            // 1. Verificar sistema b√°sico
            console.log('1Ô∏è‚É£ Verificando sistema b√°sico...');
            
            if (!window.shoppingCart) {
                resultados.errores.push('‚ùå Instancia de carrito no existe');
                return mostrarResultados(resultados);
            }
            
            if (!window.shoppingCart.isInitialized) {
                resultados.errores.push('‚ùå Carrito no est√° inicializado');
                return mostrarResultados(resultados);
            }
            
            if (typeof window.shoppingCart.addItem !== 'function') {
                resultados.errores.push('‚ùå M√©todo addItem no disponible');
                return mostrarResultados(resultados);
            }
            
            resultados.sistema = true;
            console.log('‚úÖ Sistema b√°sico OK');

            // 2. Probar agregar producto
            console.log('2Ô∏è‚É£ Probando agregar producto...');
            
            const productoTest = {
                id: `verificacion-${Date.now()}`,
                nombre: 'Producto Verificaci√≥n',
                marca: 'Test',
                precio: 99.99,
                categoria: 'test',
                imagen_url: 'test.jpg'
            };

            const itemsAntes = window.shoppingCart.getTotalItems();
            window.shoppingCart.addItem(productoTest);
            const itemsDespues = window.shoppingCart.getTotalItems();
            
            if (itemsDespues > itemsAntes) {
                resultados.agregar = true;
                console.log(`‚úÖ Producto agregado OK (${itemsAntes} ‚Üí ${itemsDespues})`);
            } else {
                resultados.errores.push('‚ùå Producto no se agreg√≥ correctamente');
                return mostrarResultados(resultados);
            }

            // 3. Verificar sincronizaci√≥n (con delay m√≠nimo)
            setTimeout(() => {
                console.log('3Ô∏è‚É£ Verificando sincronizaci√≥n...');
                
                const itemsMemoria = window.shoppingCart.getTotalItems();
                const itemsStorage = obtenerItemsStorage();
                
                if (itemsMemoria === itemsStorage) {
                    resultados.sincronizacion = true;
                    console.log(`‚úÖ Sincronizaci√≥n OK (memoria: ${itemsMemoria}, storage: ${itemsStorage})`);
                } else {
                    resultados.errores.push(`‚ùå Desincronizaci√≥n (memoria: ${itemsMemoria}, storage: ${itemsStorage})`);
                }

                // 4. Verificar persistencia
                console.log('4Ô∏è‚É£ Verificando persistencia...');
                
                const datosStorage = localStorage.getItem('shopping_cart');
                if (datosStorage) {
                    try {
                        const parsed = JSON.parse(datosStorage);
                        const tieneItems = Array.isArray(parsed) || (parsed.items && Array.isArray(parsed.items));
                        
                        if (tieneItems) {
                            resultados.persistencia = true;
                            console.log('‚úÖ Persistencia OK');
                        } else {
                            resultados.errores.push('‚ùå Formato de persistencia inv√°lido');
                        }
                    } catch (error) {
                        resultados.errores.push('‚ùå Datos de persistencia corruptos');
                    }
                } else {
                    resultados.errores.push('‚ùå No hay datos persistidos');
                }

                mostrarResultados(resultados);
            }, 100);

        } catch (error) {
            resultados.errores.push(`‚ùå Error durante verificaci√≥n: ${error.message}`);
            mostrarResultados(resultados);
        }
    };

    function obtenerItemsStorage() {
        try {
            const data = localStorage.getItem('shopping_cart');
            if (!data) return 0;
            
            const parsed = JSON.parse(data);
            const items = Array.isArray(parsed) ? parsed : (parsed.items || []);
            
            return items.reduce((total, item) => total + (item.quantity || 1), 0);
        } catch (error) {
            return 0;
        }
    }

    function mostrarResultados(resultados) {
        console.log('\nüìä RESULTADOS:');
        console.log('‚îÄ'.repeat(30));
        
        const checks = [
            { nombre: 'Sistema', estado: resultados.sistema },
            { nombre: 'Agregar', estado: resultados.agregar },
            { nombre: 'Sincronizaci√≥n', estado: resultados.sincronizacion },
            { nombre: 'Persistencia', estado: resultados.persistencia }
        ];

        checks.forEach(check => {
            const icon = check.estado ? '‚úÖ' : '‚ùå';
            console.log(`${icon} ${check.nombre}: ${check.estado ? 'OK' : 'FALLO'}`);
        });

        const todoOK = checks.every(check => check.estado);
        
        if (todoOK) {
            console.log('\nüéâ ¬°CARRITO FUNCIONANDO PERFECTAMENTE!');
            console.log('‚úÖ Todos los tests pasaron correctamente');
        } else {
            console.log('\n‚ö†Ô∏è Se detectaron problemas:');
            resultados.errores.forEach(error => {
                console.log(`  ${error}`);
            });
        }

        console.log('‚ïê'.repeat(50));
        
        return todoOK;
    }

    // Verificaci√≥n manual solamente - NO auto-ejecutar
    console.log('üìù Para verificar el carrito, usa: verificarCarrito() o checkCart()');

    // Crear m√©todo simplificado
    window.checkCart = function() {
        if (window.shoppingCart && window.shoppingCart.isInitialized) {
            const items = window.shoppingCart.getTotalItems();
            const storage = obtenerItemsStorage();
            const synced = items === storage;
            
            console.log(`üõí Carrito: ${items} items | üíæ Storage: ${storage} items | üîÑ Sync: ${synced ? 'OK' : 'ERROR'}`);
            return synced;
        } else {
            console.log('‚ùå Carrito no disponible');
            return false;
        }
    };

    // Funci√≥n para limpiar productos de prueba
    window.limpiarProductosPrueba = function() {
        if (!window.shoppingCart || !window.shoppingCart.items) {
            console.log('‚ùå Carrito no disponible');
            return false;
        }

        const itemsOriginales = window.shoppingCart.items.length;
        
        // Filtrar productos que parecen ser de prueba
        const productosLimpiados = window.shoppingCart.items.filter(item => {
            const esProductoPrueba = 
                item.id.includes('test') ||
                item.id.includes('verificacion') ||
                item.id.includes('sync-test') ||
                item.id.includes('concurrent-test') ||
                item.id.includes('memory-test') ||
                item.id.includes('timing-test') ||
                item.id.includes('duplicate-test') ||
                item.id.includes('stress') ||
                item.id.includes('quick-test') ||
                item.nombre.includes('Test') ||
                item.nombre.includes('Verificaci√≥n') ||
                item.marca === 'Test' ||
                item.categoria === 'test';
            
            return !esProductoPrueba; // Mantener solo los que NO son de prueba
        });

        window.shoppingCart.items = productosLimpiados;
        window.shoppingCart.saveToStorage();
        window.shoppingCart.updateCartUI();

        const itemsLimpiados = itemsOriginales - productosLimpiados.length;
        
        if (itemsLimpiados > 0) {
            console.log(`üßπ Se eliminaron ${itemsLimpiados} productos de prueba`);
            console.log(`üì¶ Items restantes: ${productosLimpiados.length}`);
        } else {
            console.log('‚ú® No se encontraron productos de prueba para eliminar');
        }

        return itemsLimpiados > 0;
    };

    // Funci√≥n para limpiar productos de prueba
    window.limpiarProductosPrueba = function() {
        if (!window.shoppingCart || !window.shoppingCart.items) {
            console.log('‚ùå Carrito no disponible');
            return false;
        }

        const itemsOriginales = window.shoppingCart.items.length;
        
        // Filtrar productos que parecen ser de prueba
        const productosLimpiados = window.shoppingCart.items.filter(item => {
            const esProductoPrueba = 
                item.id.includes('test') ||
                item.id.includes('verificacion') ||
                item.id.includes('sync-test') ||
                item.id.includes('concurrent-test') ||
                item.id.includes('memory-test') ||
                item.id.includes('timing-test') ||
                item.id.includes('duplicate-test') ||
                item.id.includes('stress') ||
                item.id.includes('quick-test') ||
                item.nombre.includes('Test') ||
                item.nombre.includes('Verificaci√≥n') ||
                item.marca === 'Test' ||
                item.categoria === 'test';
            
            return !esProductoPrueba; // Mantener solo los que NO son de prueba
        });

        window.shoppingCart.items = productosLimpiados;
        window.shoppingCart.saveToStorage();
        window.shoppingCart.updateCartUI();

        const itemsLimpiados = itemsOriginales - productosLimpiados.length;
        
        if (itemsLimpiados > 0) {
            console.log(`üßπ Se eliminaron ${itemsLimpiados} productos de prueba`);
            console.log(`üì¶ Items restantes: ${productosLimpiados.length}`);
        } else {
            console.log('‚ú® No se encontraron productos de prueba para eliminar');
        }

        return itemsLimpiados > 0;
    };

    console.log('üîç Verificador de carrito cargado');
    console.log('üìù Usa verificarCarrito() para test completo o checkCart() para check r√°pido');
    console.log('üßπ Usa limpiarProductosPrueba() para eliminar productos de test');

})();
