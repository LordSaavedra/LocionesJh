<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Error 500</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .log-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 11px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Error 500 - Productos</h1>
        <p>Esta herramienta diagnostica el error 500 que est√° impidiendo cargar y guardar productos.</p>

        <div class="test-section">
            <h3>üîó Tests de Conexi√≥n</h3>
            <button onclick="testConnection()">1. Test Conexi√≥n B√°sica</button>
            <button onclick="testSupabaseClient()">2. Test Cliente Supabase</button>
            <button onclick="testTableAccess()">3. Test Acceso a Tabla</button>
        </div>

        <div class="test-section">
            <h3>üìã Tests de Productos</h3>
            <button onclick="testSelectProducts()">4. Test SELECT Productos</button>
            <button onclick="testSelectProductsSimple()">5. Test SELECT Simple</button>
            <button onclick="testInsertSimple()">6. Test INSERT Simple</button>
        </div>

        <div class="test-section">
            <h3>üñºÔ∏è Tests de Im√°genes</h3>
            <button onclick="testImageProduct()">7. Test Producto con Imagen</button>
            <button onclick="testBase64Validation()">8. Test Validaci√≥n Base64</button>
        </div>

        <div class="test-section">
            <h3>üìù Log de Resultados</h3>
            <div id="logOutput" class="log-output">Esperando tests...\n</div>
            <button onclick="clearLog()">üßπ Limpiar Log</button>
        </div>
    </div>

    <!-- Scripts necesarios -->
    <script src="js/supabase-config.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ffff',
                'success': '#00ff00', 
                'warning': '#ffff00',
                'error': '#ff0000',
                'debug': '#ff00ff'
            };
            
            const coloredMessage = `[${timestamp}] ${message}\n`;
            logOutput.innerHTML += `<span style="color: ${colors[type] || '#00ffff'}">${coloredMessage}</span>`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[DIAGN√ìSTICO] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = 'Log limpiado...\n';
        }
        
        // 1. Test conexi√≥n b√°sica
        async function testConnection() {
            log('=== TEST 1: CONEXI√ìN B√ÅSICA ===', 'debug');
            
            try {
                // Verificar variables globales
                log(`window.supabase: ${typeof window.supabase}`, 'info');
                log(`supabaseClient: ${typeof supabaseClient}`, 'info');
                log(`ProductosService: ${typeof ProductosService}`, 'info');
                
                if (typeof supabaseClient === 'undefined') {
                    throw new Error('supabaseClient no est√° definido');
                }
                
                log('‚úÖ Variables globales disponibles', 'success');
                
                // Test de configuraci√≥n b√°sica
                const { data, error } = await supabaseClient.from('productos').select('count');
                
                if (error) {
                    log(`‚ùå Error en query b√°sico: ${error.message}`, 'error');
                    log(`   - C√≥digo: ${error.code}`, 'error');
                    log(`   - Detalles: ${error.details}`, 'error');
                } else {
                    log('‚úÖ Query b√°sico exitoso', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error en test de conexi√≥n: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 1 ===', 'debug');
        }
        
        // 2. Test cliente Supabase
        async function testSupabaseClient() {
            log('=== TEST 2: CLIENTE SUPABASE ===', 'debug');
            
            try {
                if (!supabaseClient) {
                    throw new Error('Cliente Supabase no disponible');
                }
                
                // Test de autenticaci√≥n (si aplica)
                const { data: { user } } = await supabaseClient.auth.getUser();
                log(`Usuario autenticado: ${user ? 'S√ç' : 'NO'}`, 'info');
                
                // Test de configuraci√≥n del proyecto
                const projectUrl = supabaseClient.supabaseUrl;
                const projectKey = supabaseClient.supabaseKey;
                
                log(`URL del proyecto: ${projectUrl ? 'CONFIGURADA' : 'NO CONFIGURADA'}`, projectUrl ? 'success' : 'error');
                log(`API Key: ${projectKey ? 'CONFIGURADA' : 'NO CONFIGURADA'}`, projectKey ? 'success' : 'error');
                
                if (projectUrl) {
                    log(`   - URL: ${projectUrl.substring(0, 30)}...`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Error en test de cliente: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 2 ===', 'debug');
        }
        
        // 3. Test acceso a tabla
        async function testTableAccess() {
            log('=== TEST 3: ACCESO A TABLA ===', 'debug');
            
            try {
                // Test simple de acceso a tabla
                const { data, error, count } = await supabaseClient
                    .from('productos')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    log(`‚ùå Error accediendo a tabla productos:`, 'error');
                    log(`   - Mensaje: ${error.message}`, 'error');
                    log(`   - C√≥digo: ${error.code}`, 'error');
                    log(`   - Hint: ${error.hint || 'No disponible'}`, 'error');
                    log(`   - Detalles: ${error.details || 'No disponible'}`, 'error');
                    
                    if (error.message.includes('permission denied')) {
                        log('   ‚ö†Ô∏è PROBLEMA: Permisos insuficientes (RLS)', 'warning');
                    }
                    
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        log('   ‚ö†Ô∏è PROBLEMA: Tabla no existe', 'warning');
                    }
                } else {
                    log(`‚úÖ Acceso a tabla exitoso`, 'success');
                    log(`   - Cantidad de productos: ${count || 'No disponible'}`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error en test de tabla: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 3 ===', 'debug');
        }
        
        // 4. Test SELECT productos
        async function testSelectProducts() {
            log('=== TEST 4: SELECT PRODUCTOS ===', 'debug');
            
            try {
                // Test con todas las columnas
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .limit(5);
                
                if (error) {
                    log(`‚ùå Error en SELECT completo: ${error.message}`, 'error');
                    
                    // Intentar con columnas b√°sicas
                    log('üîÑ Intentando con columnas b√°sicas...', 'info');
                    
                    const { data: basicData, error: basicError } = await supabaseClient
                        .from('productos')
                        .select('id, nombre, marca, precio, categoria')
                        .limit(5);
                    
                    if (basicError) {
                        log(`‚ùå Error en SELECT b√°sico: ${basicError.message}`, 'error');
                    } else {
                        log(`‚úÖ SELECT b√°sico exitoso: ${basicData.length} productos`, 'success');
                        basicData.forEach((producto, index) => {
                            log(`   ${index + 1}. ${producto.nombre} (ID: ${producto.id})`, 'info');
                        });
                    }
                } else {
                    log(`‚úÖ SELECT completo exitoso: ${data.length} productos`, 'success');
                    
                    if (data.length > 0) {
                        const primer = data[0];
                        log('üìã Estructura del primer producto:', 'info');
                        Object.keys(primer).forEach(key => {
                            const value = primer[key];
                            const tipo = typeof value;
                            const tama√±o = typeof value === 'string' ? ` (${value.length} chars)` : '';
                            log(`   - ${key}: ${tipo}${tama√±o}`, 'info');
                        });
                    }
                }
                
            } catch (error) {
                log(`‚ùå Error en test SELECT: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 4 ===', 'debug');
        }
        
        // 5. Test SELECT simple
        async function testSelectProductsSimple() {
            log('=== TEST 5: SELECT SIMPLE ===', 'debug');
            
            try {
                // Test muy b√°sico
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('id, nombre')
                    .limit(3);
                
                if (error) {
                    log(`‚ùå Error en SELECT simple: ${error.message}`, 'error');
                } else {
                    log(`‚úÖ SELECT simple exitoso: ${data.length} productos`, 'success');
                    data.forEach(p => {
                        log(`   - ID ${p.id}: ${p.nombre}`, 'info');
                    });
                }
                
            } catch (error) {
                log(`‚ùå Error en test SELECT simple: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 5 ===', 'debug');
        }
        
        // 6. Test INSERT simple
        async function testInsertSimple() {
            log('=== TEST 6: INSERT SIMPLE ===', 'debug');
            
            try {
                const testProduct = {
                    nombre: 'TEST DIAGN√ìSTICO',
                    marca: 'TEST MARCA',
                    precio: 50000,
                    categoria: 'para-ellos'
                };
                
                log('üì§ Intentando INSERT con datos m√≠nimos...', 'info');
                log(`Datos: ${JSON.stringify(testProduct)}`, 'info');
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .insert([testProduct])
                    .select();
                
                if (error) {
                    log(`‚ùå Error en INSERT: ${error.message}`, 'error');
                    log(`   - C√≥digo: ${error.code}`, 'error');
                    log(`   - Detalles: ${error.details || 'No disponible'}`, 'error');
                    log(`   - Hint: ${error.hint || 'No disponible'}`, 'error');
                    
                    if (error.message.includes('permission denied')) {
                        log('   ‚ö†Ô∏è PROBLEMA: Sin permisos de INSERT', 'warning');
                    }
                    
                    if (error.message.includes('null value')) {
                        log('   ‚ö†Ô∏è PROBLEMA: Campo requerido faltante', 'warning');
                    }
                } else {
                    log(`‚úÖ INSERT exitoso`, 'success');
                    log(`   - Producto creado con ID: ${data[0].id}`, 'success');
                    
                    // Limpiar el producto de prueba
                    await supabaseClient
                        .from('productos')
                        .delete()
                        .eq('id', data[0].id);
                    
                    log('üßπ Producto de prueba eliminado', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Error en test INSERT: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 6 ===', 'debug');
        }
        
        // 7. Test producto con imagen
        async function testImageProduct() {
            log('=== TEST 7: PRODUCTO CON IMAGEN ===', 'debug');
            
            try {
                // Crear imagen base64 peque√±a de prueba
                const testImageBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                
                const testProduct = {
                    nombre: 'TEST IMAGEN',
                    marca: 'TEST MARCA',
                    precio: 75000,
                    categoria: 'para-ellos',
                    imagen_url: testImageBase64
                };
                
                log('üì§ Intentando INSERT con imagen base64...', 'info');
                log(`Tama√±o imagen: ${testImageBase64.length} caracteres`, 'info');
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .insert([testProduct])
                    .select();
                
                if (error) {
                    log(`‚ùå Error en INSERT con imagen: ${error.message}`, 'error');
                    log(`   - C√≥digo: ${error.code}`, 'error');
                    
                    if (error.message.includes('too long')) {
                        log('   ‚ö†Ô∏è PROBLEMA: Imagen demasiado grande para la columna', 'warning');
                    }
                    
                    if (error.message.includes('invalid input')) {
                        log('   ‚ö†Ô∏è PROBLEMA: Formato de imagen inv√°lido', 'warning');
                    }
                } else {
                    log(`‚úÖ INSERT con imagen exitoso`, 'success');
                    log(`   - Producto creado con ID: ${data[0].id}`, 'success');
                    log(`   - Imagen guardada: ${data[0].imagen_url ? 'S√ç' : 'NO'}`, data[0].imagen_url ? 'success' : 'error');
                    
                    if (data[0].imagen_url) {
                        log(`   - Tama√±o imagen guardada: ${data[0].imagen_url.length} chars`, 'info');
                    }
                    
                    // Limpiar producto de prueba
                    await supabaseClient
                        .from('productos')
                        .delete()
                        .eq('id', data[0].id);
                    
                    log('üßπ Producto de prueba con imagen eliminado', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Error en test imagen: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 7 ===', 'debug');
        }
        
        // 8. Test validaci√≥n base64
        async function testBase64Validation() {
            log('=== TEST 8: VALIDACI√ìN BASE64 ===', 'debug');
            
            try {
                // Test de diferentes formatos de imagen
                const testImages = [
                    {
                        name: 'Base64 v√°lido peque√±o',
                        data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                    },
                    {
                        name: 'Base64 inv√°lido',
                        data: 'data:image/png;base64,invalid_base64_data'
                    },
                    {
                        name: 'URL normal',
                        data: 'https://example.com/image.jpg'
                    },
                    {
                        name: 'Texto plano',
                        data: 'esto_no_es_una_imagen'
                    }
                ];
                
                for (const test of testImages) {
                    log(`üß™ Probando: ${test.name}`, 'info');
                    log(`   - Datos: ${test.data.substring(0, 50)}...`, 'info');
                    log(`   - Longitud: ${test.data.length}`, 'info');
                    log(`   - Es data URL: ${test.data.startsWith('data:') ? 'S√ç' : 'NO'}`, 'info');
                    log(`   - Es base64: ${test.data.includes('base64,') ? 'S√ç' : 'NO'}`, 'info');
                    
                    if (test.data.startsWith('data:image/') && test.data.includes('base64,')) {
                        const base64Part = test.data.split('base64,')[1];
                        try {
                            atob(base64Part);
                            log(`   - Base64 v√°lido: S√ç`, 'success');
                        } catch {
                            log(`   - Base64 v√°lido: NO`, 'warning');
                        }
                    }
                    
                    log('---', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Error en validaci√≥n base64: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST 8 ===', 'debug');
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Herramienta de diagn√≥stico lista', 'success');
            log('Ejecuta los tests en orden para identificar el problema', 'info');
        });
    </script>
</body>
</html>
