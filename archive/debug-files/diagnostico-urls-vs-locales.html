<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - URLs vs Im√°genes Locales</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #2d3436;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-primary { background: #0984e3; color: white; }
        .btn-success { background: #00b894; color: white; }
        .btn-warning { background: #fdcb6e; color: #2d3436; }
        .btn-info { background: #74b9ff; color: white; }
        .btn-secondary { background: #636e72; color: white; }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }
        
        .test-section {
            background: #f8fffe;
            border: 2px solid #00b894;
            border-radius: 12px;
            padding: 25px;
            position: relative;
        }
        
        .test-section h3 {
            color: #00b894;
            margin-bottom: 20px;
            font-size: 1.4em;
            text-align: center;
        }
        
        .image-test {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .image-test img {
            width: 100%;
            max-width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
            align-self: center;
        }
        
        .image-info {
            font-size: 12px;
            color: #636e72;
            word-break: break-all;
            background: #f1f2f6;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .status.success { background: #d1f2eb; color: #00b894; }
        .status.error { background: #ffeaa7; color: #e17055; }
        .status.loading { background: #74b9ff; color: white; }
        
        .log-container {
            background: #2d3436;
            color: #ddd;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 20px 0;
        }
        
        .log-entry {
            margin: 3px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info { color: #74b9ff; }
        .log-success { color: #00b894; }
        .log-error { color: #e17055; }
        .log-warning { color: #fdcb6e; }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        
        .product-details {
            padding: 15px;
        }
        
        .product-name {
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 5px;
        }
        
        .product-price {
            color: #0984e3;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .image-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .badge-url { background: #74b9ff; color: white; }
        .badge-local { background: #00b894; color: white; }
        .badge-base64 { background: #fdcb6e; color: #2d3436; }
        .badge-error { background: #e17055; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Diagn√≥stico: URLs vs Im√°genes Locales</h1>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="conectarSupabase()">üîå Conectar Supabase</button>
            <button class="btn btn-success" onclick="cargarProductos()">üì¶ Cargar Productos</button>
            <button class="btn btn-warning" onclick="probarImagenesEjemplo()">üñºÔ∏è Probar Ejemplos</button>
            <button class="btn btn-info" onclick="analizarTiposImagen()">üîç Analizar Tipos</button>
            <button class="btn btn-secondary" onclick="limpiarResultados()">üßπ Limpiar</button>
        </div>
        
        <div class="test-grid">
            <!-- Pruebas de URLs -->
            <div class="test-section">
                <h3>üåê Pruebas con URLs Externas</h3>
                <div id="urlTests"></div>
            </div>
            
            <!-- Pruebas de Im√°genes Locales -->
            <div class="test-section">
                <h3>üìÇ Pruebas con Im√°genes Locales</h3>
                <div id="localTests"></div>
            </div>
        </div>
        
        <!-- Productos Reales -->
        <div class="test-section">
            <h3>üõçÔ∏è Productos de la Base de Datos</h3>
            <div id="realProducts" class="products-grid">
                <p style="text-align: center; color: #636e72;">Haz clic en "Cargar Productos" para ver los productos reales</p>
            </div>
        </div>
        
        <!-- Log -->
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">üöÄ Sistema de pruebas de im√°genes iniciado</div>
        </div>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        let supabaseClient = null;
        let productos = [];
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const icon = {
                'info': 'üí°',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            }[type] || 'üìù';
            
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function conectarSupabase() {
            try {
                log('Conectando a Supabase...', 'info');
                
                if (!window.supabaseUrl || !window.supabaseAnonKey) {
                    throw new Error('Configuraci√≥n de Supabase no encontrada');
                }
                
                supabaseClient = window.supabase.createClient(window.supabaseUrl, window.supabaseAnonKey);
                
                // Probar conexi√≥n
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                log('Conexi√≥n exitosa a Supabase', 'success');
                
            } catch (error) {
                log(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }
        
        async function cargarProductos() {
            if (!supabaseClient) {
                log('Primero conecta a Supabase', 'error');
                return;
            }
            
            try {
                log('Cargando productos para ellos...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .eq('categoria', 'para-ellos');
                
                if (error) throw error;
                
                productos = data || [];
                log(`${productos.length} productos cargados`, 'success');
                
                mostrarProductosReales();
                
            } catch (error) {
                log(`Error cargando productos: ${error.message}`, 'error');
            }
        }
        
        function mostrarProductosReales() {
            const container = document.getElementById('realProducts');
            
            if (productos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #e17055;">No hay productos para mostrar</p>';
                return;
            }
            
            const productosHTML = productos.map(producto => {
                const imagenPath = producto.imagen_url || producto.imagen;
                const tipoImagen = determinarTipoImagen(imagenPath);
                const badgeClass = {
                    'URL': 'badge-url',
                    'Local': 'badge-local',
                    'Base64': 'badge-base64',
                    'Error': 'badge-error'
                }[tipoImagen] || 'badge-error';
                
                return `
                    <div class="product-card">
                        <div class="image-type-badge ${badgeClass}">${tipoImagen}</div>
                        <img class="product-image" 
                             src="${procesarRutaImagen(imagenPath)}" 
                             alt="${producto.nombre}"
                             onerror="handleImageError(this, '${producto.nombre}', '${imagenPath}')"
                             onload="handleImageSuccess(this, '${producto.nombre}', '${imagenPath}')">
                        <div class="product-details">
                            <div class="product-name">${producto.nombre}</div>
                            <div class="product-price">$${formatPrice(producto.precio)}</div>
                            <div class="image-info">
                                <strong>Ruta original:</strong><br>
                                ${imagenPath || 'Sin imagen'}<br>
                                <strong>Ruta procesada:</strong><br>
                                ${procesarRutaImagen(imagenPath)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = productosHTML;
        }
        
        function determinarTipoImagen(imagePath) {
            if (!imagePath) return 'Error';
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) return 'URL';
            if (imagePath.startsWith('data:image/')) return 'Base64';
            return 'Local';
        }
        
        function procesarRutaImagen(imagePath) {
            if (!imagePath) return 'IMAGENES/placeholder-simple.svg';
            
            // URLs externas y base64 se usan tal como est√°n
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://') || imagePath.startsWith('data:image/')) {
                return imagePath;
            }
            
            // Para rutas locales, ajustar seg√∫n contexto
            const currentPath = window.location.pathname;
            const isInHtmlFolder = currentPath.includes('/html/') || currentPath.includes('\\html\\');
            
            if (imagePath.startsWith('../')) {
                return imagePath;
            }
            
            if (isInHtmlFolder && !imagePath.startsWith('../')) {
                return `../${imagePath}`;
            }
            
            return imagePath;
        }
        
        function handleImageError(imgElement, productName, originalPath) {
            log(`‚ùå Error cargando imagen: ${productName} (${originalPath})`, 'error');
            imgElement.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"><rect width="200" height="150" fill="%23f8f9fa" stroke="%23dee2e6"/><text x="100" y="75" text-anchor="middle" fill="%23adb5bd" font-family="Arial" font-size="12">Imagen no disponible</text></svg>';
        }
        
        function handleImageSuccess(imgElement, productName, originalPath) {
            log(`‚úÖ Imagen cargada: ${productName}`, 'success');
        }
        
        async function probarImagenesEjemplo() {
            log('Probando diferentes tipos de im√°genes...', 'info');
            
            // URLs de ejemplo
            const urlTests = [
                {
                    name: 'Imagen desde Picsum',
                    url: 'https://picsum.photos/200/150?random=1',
                    type: 'URL Externa'
                },
                {
                    name: 'Imagen desde Unsplash',
                    url: 'https://images.unsplash.com/photo-1541643600914-78b084683601?w=200&h=150&fit=crop',
                    type: 'URL Externa'
                }
            ];
            
            // Im√°genes locales de ejemplo
            const localTests = [
                {
                    name: '212 Carolina Herrera',
                    url: 'LOCIONES_PARA _ELLOS/212_CAROLINA_HERRERA.png',
                    type: 'Imagen Local'
                },
                {
                    name: 'Versace Eros Blue',
                    url: 'LOCIONES_PARA _ELLOS/VERSACE_EROS_BLUE.png',
                    type: 'Imagen Local'
                },
                {
                    name: 'One Million',
                    url: 'LOCIONES_PARA _ELLOS/ONE_MILLON_PACO_RABANE.png',
                    type: 'Imagen Local'
                }
            ];
            
            // Mostrar pruebas de URLs
            const urlContainer = document.getElementById('urlTests');
            urlContainer.innerHTML = urlTests.map(test => `
                <div class="image-test">
                    <img src="${test.url}" 
                         alt="${test.name}"
                         onerror="this.nextElementSibling.innerHTML = '‚ùå Error'; log('‚ùå Error: ${test.name}', 'error')"
                         onload="this.nextElementSibling.innerHTML = '‚úÖ Cargada'; log('‚úÖ √âxito: ${test.name}', 'success')">
                    <div class="status loading">‚è≥ Cargando...</div>
                    <div class="image-info">
                        <strong>Nombre:</strong> ${test.name}<br>
                        <strong>Tipo:</strong> ${test.type}<br>
                        <strong>URL:</strong> ${test.url}
                    </div>
                </div>
            `).join('');
            
            // Mostrar pruebas locales
            const localContainer = document.getElementById('localTests');
            localContainer.innerHTML = localTests.map(test => {
                const processedUrl = procesarRutaImagen(test.url);
                return `
                    <div class="image-test">
                        <img src="${processedUrl}" 
                             alt="${test.name}"
                             onerror="this.nextElementSibling.innerHTML = '‚ùå Error'; log('‚ùå Error: ${test.name}', 'error')"
                             onload="this.nextElementSibling.innerHTML = '‚úÖ Cargada'; log('‚úÖ √âxito: ${test.name}', 'success')">
                        <div class="status loading">‚è≥ Cargando...</div>
                        <div class="image-info">
                            <strong>Nombre:</strong> ${test.name}<br>
                            <strong>Tipo:</strong> ${test.type}<br>
                            <strong>Ruta original:</strong> ${test.url}<br>
                            <strong>Ruta procesada:</strong> ${processedUrl}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function analizarTiposImagen() {
            if (productos.length === 0) {
                log('Carga productos primero', 'warning');
                return;
            }
            
            const analisis = {
                total: productos.length,
                conImagen: 0,
                sinImagen: 0,
                urls: 0,
                locales: 0,
                base64: 0
            };
            
            productos.forEach(producto => {
                const imagen = producto.imagen_url || producto.imagen;
                
                if (!imagen) {
                    analisis.sinImagen++;
                } else {
                    analisis.conImagen++;
                    
                    if (imagen.startsWith('http://') || imagen.startsWith('https://')) {
                        analisis.urls++;
                    } else if (imagen.startsWith('data:image/')) {
                        analisis.base64++;
                    } else {
                        analisis.locales++;
                    }
                }
            });
            
            log('=== AN√ÅLISIS DE TIPOS DE IMAGEN ===', 'info');
            log(`Total productos: ${analisis.total}`, 'info');
            log(`Con imagen: ${analisis.conImagen}`, 'success');
            log(`Sin imagen: ${analisis.sinImagen}`, 'warning');
            log(`URLs externas: ${analisis.urls}`, 'info');
            log(`Im√°genes locales: ${analisis.locales}`, 'info');
            log(`Base64: ${analisis.base64}`, 'info');
            log('=== FIN AN√ÅLISIS ===', 'info');
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('es-CO').format(price || 0);
        }
        
        function limpiarResultados() {
            document.getElementById('urlTests').innerHTML = '';
            document.getElementById('localTests').innerHTML = '';
            document.getElementById('realProducts').innerHTML = '<p style="text-align: center; color: #636e72;">Resultados limpiados</p>';
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">üßπ Resultados limpiados</div>';
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', () => {
            log('Sistema de pruebas listo', 'success');
        });
    </script>
</body>
</html>
