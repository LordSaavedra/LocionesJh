<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Edici√≥n de Productos</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .diagnostic-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .diagnostic-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        .test-form {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
        }
        
        .btn:hover {
            background: #218838;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .product-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 15px;
            border: 1px solid #e9ecef;
        }
        
        .product-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #fff;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-info { background: rgba(23, 162, 184, 0.2); }
        .log-success { background: rgba(40, 167, 69, 0.2); }
        .log-warning { background: rgba(255, 193, 7, 0.2); }
        .log-error { background: rgba(220, 53, 69, 0.2); }
        
        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 5px;
            display: inline-block;
        }
        
        .status-ok {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .edit-form-container {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .edit-form-container.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úèÔ∏è Diagn√≥stico de Edici√≥n de Productos</h1>
        
        <div class="diagnostic-section">
            <h3>üìä Estado del Sistema de Edici√≥n</h3>
            <div id="systemStatus">
                Verificando sistema de edici√≥n...
            </div>
        </div>
        
        <div class="diagnostic-section">
            <h3>üì¶ Productos Disponibles para Edici√≥n</h3>
            <button id="loadProducts" class="btn">üîÑ Cargar Productos</button>
            <div id="productsList">
                No se han cargado productos a√∫n...
            </div>
        </div>
        
        <div class="edit-form-container" id="editFormContainer">
            <h3>‚úèÔ∏è Editando Producto</h3>
            <div class="test-form">
                <div class="form-group">
                    <label for="editNombre">Nombre del Producto:</label>
                    <input type="text" id="editNombre" placeholder="Nombre del producto">
                </div>
                
                <div class="form-group">
                    <label for="editMarca">Marca:</label>
                    <input type="text" id="editMarca" placeholder="Marca del producto">
                </div>
                
                <div class="form-group">
                    <label for="editPrecio">Precio (COP):</label>
                    <input type="number" id="editPrecio" placeholder="50000">
                </div>
                
                <div class="form-group">
                    <label for="editCategoria">Categor√≠a:</label>
                    <select id="editCategoria">
                        <option value="para-ellos">Para Ellos</option>
                        <option value="para-ellas">Para Ellas</option>
                        <option value="unisex">Unisex</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editDescripcion">Descripci√≥n:</label>
                    <textarea id="editDescripcion" rows="3" placeholder="Descripci√≥n del producto"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editImagenUrl">URL de Imagen:</label>
                    <input type="url" id="editImagenUrl" placeholder="https://ejemplo.com/imagen.jpg">
                </div>
                
                <div class="form-group">
                    <label for="editEstado">Estado:</label>
                    <select id="editEstado">
                        <option value="disponible">Disponible</option>
                        <option value="agotado">Agotado</option>
                        <option value="proximo">Disponible Pr√≥ximamente</option>
                        <option value="oferta">En Oferta</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editActivo"> Producto activo
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="saveEditedProduct" class="btn">üíæ Guardar Cambios</button>
                    <button id="cancelEdit" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button id="testDuplicateEdit" class="btn btn-warning">‚ö° Test Edici√≥n Doble</button>
                </div>
            </div>
        </div>
        
        <div class="diagnostic-section">
            <h3>üß™ Tests de Edici√≥n</h3>
            <button id="testEditFlow" class="btn">üîç Test: Flujo Completo de Edici√≥n</button>
            <button id="testEditValidation" class="btn">‚úÖ Test: Validaci√≥n de Edici√≥n</button>
            <button id="testImageEdit" class="btn">üñºÔ∏è Test: Edici√≥n de Imagen</button>
            <button id="testConcurrentEdit" class="btn btn-warning">‚ö° Test: Edici√≥n Concurrente</button>
        </div>
        
        <div class="diagnostic-section">
            <h3>üìã Log de Eventos</h3>
            <div id="logContainer" class="log-container">
                <div class="log-entry log-info">üöÄ Sistema de diagn√≥stico de edici√≥n iniciado...</div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Configuraci√≥n y servicios -->
    <script src="js/supabase-config.js"></script>
    <script src="js/admin-panel-new.js"></script>
    
    <script>
        class EditDiagnosticSystem {
            constructor() {
                this.products = [];
                this.currentEditingProduct = null;
                this.logContainer = document.getElementById('logContainer');
                this.isEditing = false;
                
                this.init();
            }
            
            init() {
                this.log('üöÄ Iniciando sistema de diagn√≥stico de edici√≥n...', 'info');
                this.setupEventListeners();
                this.checkSystemStatus();
            }
            
            setupEventListeners() {
                document.getElementById('loadProducts').addEventListener('click', () => {
                    this.loadProducts();
                });
                
                document.getElementById('saveEditedProduct').addEventListener('click', () => {
                    this.saveEditedProduct();
                });
                
                document.getElementById('cancelEdit').addEventListener('click', () => {
                    this.cancelEdit();
                });
                
                document.getElementById('testDuplicateEdit').addEventListener('click', () => {
                    this.testDuplicateEdit();
                });
                
                // Tests
                document.getElementById('testEditFlow').addEventListener('click', () => {
                    this.testEditFlow();
                });
                
                document.getElementById('testEditValidation').addEventListener('click', () => {
                    this.testEditValidation();
                });
                
                document.getElementById('testImageEdit').addEventListener('click', () => {
                    this.testImageEdit();
                });
                
                document.getElementById('testConcurrentEdit').addEventListener('click', () => {
                    this.testConcurrentEdit();
                });
            }
            
            async checkSystemStatus() {
                this.log('üîç Verificando estado del sistema de edici√≥n...', 'info');
                
                const status = {
                    supabase: typeof window.supabase !== 'undefined',
                    adminPanel: typeof AdminPanel !== 'undefined',
                    productosService: typeof ProductosService !== 'undefined',
                    updateProduct: typeof ProductosService?.updateProduct === 'function'
                };
                
                let statusHtml = '<h4>Estado de Dependencias para Edici√≥n:</h4>';
                
                for (const [key, value] of Object.entries(status)) {
                    const statusClass = value ? 'status-ok' : 'status-error';
                    const statusText = value ? '‚úÖ OK' : '‚ùå ERROR';
                    statusHtml += `<span class="status-indicator ${statusClass}">${key}: ${statusText}</span>`;
                }
                
                // Verificar m√©todos espec√≠ficos de edici√≥n
                if (typeof adminPanel !== 'undefined' && adminPanel) {
                    const editMethods = ['editProduct', 'populateEditForm', 'setFormEditMode', 'updateProduct'];
                    statusHtml += `<br><br><strong>M√©todos de Edici√≥n:</strong><br>`;
                    
                    editMethods.forEach(method => {
                        const exists = typeof adminPanel[method] === 'function';
                        const statusClass = exists ? 'status-ok' : 'status-error';
                        const statusText = exists ? '‚úÖ' : '‚ùå';
                        statusHtml += `<span class="status-indicator ${statusClass}">${method}: ${statusText}</span>`;
                    });
                }
                
                document.getElementById('systemStatus').innerHTML = statusHtml;
                this.log('üìä Estado del sistema verificado', 'success');
            }
            
            async loadProducts() {
                this.log('üì¶ Cargando productos para edici√≥n...', 'info');
                
                try {
                    if (typeof ProductosService === 'undefined') {
                        throw new Error('ProductosService no disponible');
                    }
                    
                    const products = await ProductosService.obtenerProductos();
                    this.products = products || [];
                    
                    this.log(`‚úÖ Productos cargados: ${this.products.length}`, 'success');
                    this.displayProducts();
                    
                } catch (error) {
                    this.log(`‚ùå Error cargando productos: ${error.message}`, 'error');
                    document.getElementById('productsList').innerHTML = 
                        `<div style="color: red;">Error: ${error.message}</div>`;
                }
            }
            
            displayProducts() {
                const container = document.getElementById('productsList');
                
                if (this.products.length === 0) {
                    container.innerHTML = '<div>No hay productos disponibles</div>';
                    return;
                }
                
                let html = `<h4>Productos Disponibles (${this.products.length}):</h4>`;
                
                this.products.slice(0, 10).forEach(product => {
                    const imageHtml = product.imagen_url || product.imagen ? 
                        `<img src="${product.imagen_url || product.imagen}" class="product-image" alt="${product.nombre}" onerror="this.style.display='none'">` : 
                        '<div class="product-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">Sin imagen</div>';
                    
                    html += `
                        <div class="product-card">
                            <div class="product-header">
                                ${imageHtml}
                                <div class="product-info">
                                    <strong>${product.nombre}</strong><br>
                                    <small>Marca: ${product.marca} | Precio: $${product.precio?.toLocaleString()} | ID: ${product.id}</small><br>
                                    <small>Estado: ${product.estado || 'N/A'} | Activo: ${product.activo ? 'S√≠' : 'No'}</small>
                                </div>
                                <div class="product-actions">
                                    <button class="btn" onclick="editDiagnostic.startEdit(${product.id})">
                                        ‚úèÔ∏è Editar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (this.products.length > 10) {
                    html += `<div style="text-align: center; margin: 10px;"><small>... y ${this.products.length - 10} productos m√°s</small></div>`;
                }
                
                container.innerHTML = html;
            }
            
            startEdit(productId) {
                this.log(`‚úèÔ∏è Iniciando edici√≥n del producto ID: ${productId}`, 'info');
                
                const product = this.products.find(p => p.id === productId);
                if (!product) {
                    this.log(`‚ùå Producto ID ${productId} no encontrado`, 'error');
                    return;
                }
                
                this.currentEditingProduct = product;
                this.populateEditForm(product);
                
                // Mostrar formulario de edici√≥n
                document.getElementById('editFormContainer').classList.add('active');
                
                this.log(`üìù Formulario poblado con datos de: ${product.nombre}`, 'success');
            }
            
            populateEditForm(product) {
                document.getElementById('editNombre').value = product.nombre || '';
                document.getElementById('editMarca').value = product.marca || '';
                document.getElementById('editPrecio').value = product.precio || '';
                document.getElementById('editCategoria').value = product.categoria || 'para-ellos';
                document.getElementById('editDescripcion').value = product.descripcion || '';
                document.getElementById('editImagenUrl').value = product.imagen_url || product.imagen || '';
                document.getElementById('editEstado').value = product.estado || 'disponible';
                document.getElementById('editActivo').checked = product.activo !== false;
            }
            
            async saveEditedProduct() {
                if (this.isEditing) {
                    this.log('‚ö†Ô∏è Ya hay una edici√≥n en progreso, ignorando...', 'warning');
                    return;
                }
                
                if (!this.currentEditingProduct) {
                    this.log('‚ùå No hay producto seleccionado para editar', 'error');
                    return;
                }
                
                this.isEditing = true;
                
                try {
                    this.log(`üíæ Guardando cambios en producto ID: ${this.currentEditingProduct.id}`, 'info');
                    
                    const updatedData = {
                        nombre: document.getElementById('editNombre').value.trim(),
                        marca: document.getElementById('editMarca').value.trim(),
                        precio: parseInt(document.getElementById('editPrecio').value),
                        categoria: document.getElementById('editCategoria').value,
                        descripcion: document.getElementById('editDescripcion').value.trim(),
                        imagen_url: document.getElementById('editImagenUrl').value.trim(),
                        estado: document.getElementById('editEstado').value,
                        activo: document.getElementById('editActivo').checked
                    };
                    
                    // Validar datos b√°sicos
                    if (!updatedData.nombre || !updatedData.marca || !updatedData.precio || !updatedData.categoria) {
                        throw new Error('Campos requeridos faltantes');
                    }
                    
                    this.log('üì§ Datos preparados para actualizaci√≥n:', 'info');
                    console.log('Datos a enviar:', updatedData);
                    
                    // Usar el m√©todo de AdminPanel si est√° disponible
                    let result;
                    if (typeof adminPanel !== 'undefined' && adminPanel && typeof adminPanel.updateProduct === 'function') {
                        this.log('üîÑ Usando AdminPanel.updateProduct...', 'info');
                        result = await adminPanel.updateProduct(this.currentEditingProduct.id, updatedData);
                    } else if (typeof ProductosService !== 'undefined' && typeof ProductosService.updateProduct === 'function') {
                        this.log('üîÑ Usando ProductosService.updateProduct...', 'info');
                        result = await ProductosService.updateProduct(this.currentEditingProduct.id, updatedData);
                    } else {
                        throw new Error('No hay m√©todo de actualizaci√≥n disponible');
                    }
                    
                    if (result) {
                        this.log('‚úÖ Producto actualizado exitosamente', 'success');
                        this.log(`üìä Resultado: ID ${result.id}, Nombre: ${result.nombre}`, 'success');
                        
                        // Actualizar producto en lista local
                        const index = this.products.findIndex(p => p.id === this.currentEditingProduct.id);
                        if (index !== -1) {
                            this.products[index] = { ...this.products[index], ...result };
                        }
                        
                        // Actualizar display
                        this.displayProducts();
                        
                        // Cerrar formulario de edici√≥n
                        this.cancelEdit();
                        
                    } else {
                        this.log('‚ö†Ô∏è Actualizaci√≥n completada pero sin resultado v√°lido', 'warning');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Error guardando cambios: ${error.message}`, 'error');
                    console.error('Error completo:', error);
                } finally {
                    this.isEditing = false;
                }
            }
            
            cancelEdit() {
                this.log('‚ùå Edici√≥n cancelada', 'info');
                this.currentEditingProduct = null;
                document.getElementById('editFormContainer').classList.remove('active');
            }
            
            async testDuplicateEdit() {
                this.log('‚ö° Iniciando test de edici√≥n doble...', 'warning');
                
                if (!this.currentEditingProduct) {
                    this.log('‚ùå No hay producto en edici√≥n para test', 'error');
                    return;
                }
                
                // Dos clicks r√°pidos
                setTimeout(() => this.saveEditedProduct(), 0);
                setTimeout(() => this.saveEditedProduct(), 50);
            }
            
            async testEditFlow() {
                this.log('üîç Iniciando test de flujo completo de edici√≥n...', 'info');
                
                if (this.products.length === 0) {
                    await this.loadProducts();
                }
                
                if (this.products.length === 0) {
                    this.log('‚ùå No hay productos para probar edici√≥n', 'error');
                    return;
                }
                
                // Seleccionar primer producto
                const testProduct = this.products[0];
                this.log(`üìù Probando edici√≥n con producto: ${testProduct.nombre}`, 'info');
                
                // Simular edici√≥n
                this.startEdit(testProduct.id);
                
                // Modificar algunos campos
                document.getElementById('editNombre').value = testProduct.nombre + ' (EDITADO)';
                document.getElementById('editDescripcion').value = 'Descripci√≥n actualizada por test';
                
                this.log('‚úèÔ∏è Campos modificados para test', 'info');
                this.log('‚úÖ Test de flujo completado - Producto listo para editar', 'success');
            }
            
            async testEditValidation() {
                this.log('‚úÖ Iniciando test de validaci√≥n de edici√≥n...', 'info');
                
                // Crear producto de test con datos inv√°lidos
                this.currentEditingProduct = { id: 999, nombre: 'Test Product' };
                document.getElementById('editFormContainer').classList.add('active');
                
                // Test 1: Campos vac√≠os
                document.getElementById('editNombre').value = '';
                document.getElementById('editMarca').value = '';
                
                try {
                    await this.saveEditedProduct();
                } catch (error) {
                    this.log('‚úÖ Validaci√≥n de campos vac√≠os funcionando', 'success');
                }
                
                // Test 2: Precio inv√°lido
                document.getElementById('editNombre').value = 'Test';
                document.getElementById('editMarca').value = 'Test';
                document.getElementById('editPrecio').value = 'no-es-numero';
                
                this.log('‚úÖ Tests de validaci√≥n completados', 'success');
                this.cancelEdit();
            }
            
            async testImageEdit() {
                this.log('üñºÔ∏è Iniciando test de edici√≥n de imagen...', 'info');
                
                if (this.products.length === 0) {
                    await this.loadProducts();
                }
                
                const productWithImage = this.products.find(p => p.imagen_url || p.imagen);
                
                if (productWithImage) {
                    this.startEdit(productWithImage.id);
                    
                    // Cambiar URL de imagen
                    document.getElementById('editImagenUrl').value = 'https://via.placeholder.com/300x300?text=TEST+IMAGE';
                    
                    this.log('üñºÔ∏è Test de imagen configurado - URL cambiada', 'success');
                } else {
                    this.log('‚ö†Ô∏è No se encontr√≥ producto con imagen para test', 'warning');
                }
            }
            
            async testConcurrentEdit() {
                this.log('‚ö° Iniciando test de edici√≥n concurrente...', 'warning');
                
                if (this.products.length === 0) {
                    await this.loadProducts();
                }
                
                if (this.products.length === 0) {
                    this.log('‚ùå No hay productos para test concurrente', 'error');
                    return;
                }
                
                const testProduct = this.products[0];
                this.startEdit(testProduct.id);
                
                // Simular m√∫ltiples ediciones simult√°neas
                document.getElementById('editNombre').value = testProduct.nombre + ' (CONCURRENT TEST)';
                
                this.log('‚ö° Iniciando 3 ediciones simult√°neas...', 'warning');
                
                // 3 ediciones con diferentes delays
                setTimeout(() => this.saveEditedProduct(), 0);
                setTimeout(() => this.saveEditedProduct(), 25);
                setTimeout(() => this.saveEditedProduct(), 50);
                
                this.log('‚ö° Test de concurrencia iniciado', 'warning');
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
                
                console.log(`[EDIT-DIAGNOSTIC] ${message}`);
            }
        }
        
        // Inicializar cuando todo est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.editDiagnostic = new EditDiagnosticSystem();
            }, 1000);
        });
    </script>
</body>
</html>
