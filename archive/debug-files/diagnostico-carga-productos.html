<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico: Carga de Productos - Aromes De Dieu</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
        }
        .status-card.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .status-card.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status-card.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .output {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.4;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
        }
        .metric-label {
            font-weight: bold;
        }
        .metric-value {
            font-family: monospace;
        }
        .loading {
            display: none;
            color: #007bff;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico: ¬øPor qu√© se cargan productos locales?</h1>
        <p>Esta p√°gina diagnostica por qu√© el sistema est√° cargando productos desde datos locales en lugar de la base de datos.</p>
        
        <div class="status-grid">
            <div class="status-card" id="supabaseStatus">
                <h3>üì° Estado de Supabase</h3>
                <div class="metric">
                    <span class="metric-label">Cliente inicializado:</span>
                    <span class="metric-value" id="clientStatus">Verificando...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Librer√≠a cargada:</span>
                    <span class="metric-value" id="libraryStatus">Verificando...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Configuraci√≥n:</span>
                    <span class="metric-value" id="configStatus">Verificando...</span>
                </div>
            </div>
            
            <div class="status-card" id="connectionStatus">
                <h3>üîó Estado de Conexi√≥n</h3>
                <div class="metric">
                    <span class="metric-label">Ping BD:</span>
                    <span class="metric-value" id="pingStatus">No probado</span>
                </div>
                <div class="metric">
                    <span class="metric-label">√öltimos logs:</span>
                    <span class="metric-value" id="lastLogs">Sin logs</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Errores recientes:</span>
                    <span class="metric-value" id="recentErrors">Ninguno</span>
                </div>
            </div>
            
            <div class="status-card" id="dataStatus">
                <h3>üìä Estado de Datos</h3>
                <div class="metric">
                    <span class="metric-label">Fuente actual:</span>
                    <span class="metric-value" id="dataSource">Desconocida</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Cache activo:</span>
                    <span class="metric-value" id="cacheStatus">No verificado</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Productos cargados:</span>
                    <span class="metric-value" id="productCount">0</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>üß™ Pruebas de Diagn√≥stico</h3>
            <button class="btn" onclick="runFullDiagnostic()">
                üîç Diagn√≥stico Completo
            </button>
            <button class="btn btn-success" onclick="testSupabaseInit()">
                üöÄ Test Inicializaci√≥n
            </button>
            <button class="btn btn-warning" onclick="testDirectQuery()">
                üì° Test Query Directa
            </button>
            <button class="btn btn-danger" onclick="forceLocalData()">
                üìã Forzar Datos Locales
            </button>
            <button class="btn" onclick="clearOutput()">
                üóëÔ∏è Limpiar Output
            </button>
        </div>
        
        <div class="loading" id="loading">
            üîÑ Ejecutando diagn√≥stico...
        </div>
        
        <div class="output" id="diagnosticOutput">Listo para ejecutar diagn√≥stico...</div>
        
        <div class="section">
            <h3>üí° Posibles Causas y Soluciones</h3>
            <div id="recommendations">
                <p><em>Ejecuta el diagn√≥stico completo para ver recomendaciones espec√≠ficas.</em></p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    
    <script>
        let output = document.getElementById('diagnosticOutput');
        let loading = document.getElementById('loading');
        
        // Variables para capturar logs
        let capturedLogs = [];
        let capturedErrors = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorCodes = {
                info: '\x1b[36m',
                success: '\x1b[32m',
                warning: '\x1b[33m',
                error: '\x1b[31m',
                reset: '\x1b[0m'
            };
            
            const logMessage = `[${timestamp}] ${message}`;
            output.textContent += `${logMessage}\n`;
            output.scrollTop = output.scrollHeight;
            
            console.log(message);
            capturedLogs.push({ timestamp, message, type });
            
            if (type === 'error') {
                capturedErrors.push({ timestamp, message });
            }
        }
        
        function updateStatus(cardId, status) {
            const card = document.getElementById(cardId);
            card.className = `status-card ${status}`;
        }
        
        function updateMetric(id, value) {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        }
        
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }
        
        function clearOutput() {
            output.textContent = 'Output limpio. Listo para nuevas pruebas...\n';
            capturedLogs = [];
            capturedErrors = [];
        }
        
        // Diagn√≥stico completo
        async function runFullDiagnostic() {
            showLoading(true);
            log('üîç INICIANDO DIAGN√ìSTICO COMPLETO', 'info');
            log('==========================================');
            
            try {
                // 1. Verificar dependencias
                await checkDependencies();
                
                // 2. Verificar inicializaci√≥n
                await checkInitialization();
                
                // 3. Probar conexi√≥n
                await testConnection();
                
                // 4. Probar carga de productos
                await testProductLoading();
                
                // 5. Analizar resultados
                await analyzeResults();
                
                log('==========================================');
                log('‚úÖ DIAGN√ìSTICO COMPLETO FINALIZADO', 'success');
                
            } catch (error) {
                log(`‚ùå Error en diagn√≥stico: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function checkDependencies() {
            log('üì¶ 1. VERIFICANDO DEPENDENCIAS...');
            
            // Verificar window.supabase
            const hasSupabaseLib = typeof window.supabase !== 'undefined';
            log(`   Librer√≠a Supabase: ${hasSupabaseLib ? '‚úÖ' : '‚ùå'}`, hasSupabaseLib ? 'success' : 'error');
            updateMetric('libraryStatus', hasSupabaseLib ? '‚úÖ Cargada' : '‚ùå No cargada');
            
            // Verificar configuraci√≥n
            const hasConfig = !!(window.SUPABASE_URL || SUPABASE_URL) && !!(window.SUPABASE_ANON_KEY || SUPABASE_ANON_KEY);
            log(`   Configuraci√≥n: ${hasConfig ? '‚úÖ' : '‚ùå'}`, hasConfig ? 'success' : 'error');
            updateMetric('configStatus', hasConfig ? '‚úÖ V√°lida' : '‚ùå Faltante');
            
            // Verificar ProductosService
            const hasService = typeof ProductosService !== 'undefined';
            log(`   ProductosService: ${hasService ? '‚úÖ' : '‚ùå'}`, hasService ? 'success' : 'error');
            
            if (!hasSupabaseLib) {
                log('   ‚ö†Ô∏è PROBLEMA: La librer√≠a de Supabase no est√° cargada', 'warning');
                updateStatus('supabaseStatus', 'error');
                return false;
            }
            
            updateStatus('supabaseStatus', hasConfig ? 'success' : 'warning');
            return true;
        }
        
        async function checkInitialization() {
            log('üöÄ 2. VERIFICANDO INICIALIZACI√ìN...');
            
            // Verificar cliente
            const hasClient = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
            log(`   Cliente existente: ${hasClient ? '‚úÖ' : '‚ùå'}`, hasClient ? 'success' : 'error');
            updateMetric('clientStatus', hasClient ? '‚úÖ Inicializado' : '‚ùå No inicializado');
            
            if (!hasClient) {
                log('   üîÑ Intentando inicializar...', 'warning');
                try {
                    const result = initSupabase();
                    const newClient = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
                    log(`   Resultado inicializaci√≥n: ${result ? '‚úÖ' : '‚ùå'}`, result ? 'success' : 'error');
                    log(`   Cliente despu√©s de init: ${newClient ? '‚úÖ' : '‚ùå'}`, newClient ? 'success' : 'error');
                    updateMetric('clientStatus', newClient ? '‚úÖ Inicializado' : '‚ùå Fall√≥');
                    return newClient;
                } catch (error) {
                    log(`   ‚ùå Error inicializando: ${error.message}`, 'error');
                    updateMetric('clientStatus', '‚ùå Error');
                    return false;
                }
            }
            
            return true;
        }
        
        async function testConnection() {
            log('üîó 3. PROBANDO CONEXI√ìN...');
            
            if (!supabaseClient) {
                log('   ‚ùå No hay cliente para probar', 'error');
                updateMetric('pingStatus', '‚ùå Sin cliente');
                updateStatus('connectionStatus', 'error');
                return false;
            }
            
            try {
                log('   üì° Ejecutando ping a base de datos...');
                const startTime = Date.now();
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('count')
                    .limit(1);
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (error) {
                    log(`   ‚ùå Error en ping: ${error.message}`, 'error');
                    log(`   üìã C√≥digo de error: ${error.code}`, 'error');
                    updateMetric('pingStatus', `‚ùå Error: ${error.code}`);
                    updateStatus('connectionStatus', 'error');
                    return false;
                }
                
                log(`   ‚úÖ Ping exitoso en ${duration}ms`, 'success');
                updateMetric('pingStatus', `‚úÖ ${duration}ms`);
                updateStatus('connectionStatus', 'success');
                return true;
                
            } catch (error) {
                log(`   ‚ùå Excepci√≥n en ping: ${error.message}`, 'error');
                updateMetric('pingStatus', '‚ùå Excepci√≥n');
                updateStatus('connectionStatus', 'error');
                return false;
            }
        }
        
        async function testProductLoading() {
            log('üìä 4. PROBANDO CARGA DE PRODUCTOS...');
            
            if (!supabaseClient) {
                log('   ‚ö†Ô∏è Sin cliente - usando datos locales esperado', 'warning');
                updateMetric('dataSource', 'Local (sin cliente)');
                return;
            }
            
            try {
                log('   üîÑ Intentando cargar productos...');
                const startTime = Date.now();
                
                const productos = await ProductosService.obtenerProductos();
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                log(`   ‚è±Ô∏è Carga completada en ${duration}ms`, 'info');
                log(`   üì¶ Productos obtenidos: ${productos.length}`, 'info');
                
                updateMetric('productCount', productos.length);
                
                // Analizar origen de los datos
                if (productos.length > 0) {
                    const firstProduct = productos[0];
                    if (firstProduct.id && typeof firstProduct.id === 'number' && firstProduct.id < 10) {
                        log('   ‚ö†Ô∏è DETECTADO: Datos locales (IDs bajos y secuenciales)', 'warning');
                        updateMetric('dataSource', '‚ùå Local');
                        updateStatus('dataStatus', 'error');
                    } else {
                        log('   ‚úÖ Datos de base de datos (IDs de BD)', 'success');
                        updateMetric('dataSource', '‚úÖ Base de Datos');
                        updateStatus('dataStatus', 'success');
                    }
                    
                    log(`   üìã Primer producto: ${firstProduct.nombre} (ID: ${firstProduct.id})`, 'info');
                } else {
                    log('   ‚ö†Ô∏è No se obtuvieron productos', 'warning');
                    updateMetric('dataSource', '‚ö†Ô∏è Sin datos');
                    updateStatus('dataStatus', 'warning');
                }
                
                // Verificar cache
                const cacheStatus = ProductosService._cache.productos ? 'Activo' : 'Vac√≠o';
                updateMetric('cacheStatus', cacheStatus);
                
            } catch (error) {
                log(`   ‚ùå Error cargando productos: ${error.message}`, 'error');
                updateMetric('dataSource', '‚ùå Error');
                updateStatus('dataStatus', 'error');
            }
        }
        
        async function analyzeResults() {
            log('üî¨ 5. ANALIZANDO RESULTADOS...');
            
            const recommendations = document.getElementById('recommendations');
            let html = '<h4>üîç An√°lisis:</h4><ul>';
            
            // Analizar logs capturados
            const hasErrors = capturedErrors.length > 0;
            const hasSupabaseClient = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
            const dataSource = document.getElementById('dataSource').textContent;
            
            if (!hasSupabaseClient) {
                html += '<li><strong>‚ùå Problema Principal:</strong> Cliente Supabase no inicializado</li>';
                html += '<li><strong>üí° Soluci√≥n:</strong> Verificar que la librer√≠a de Supabase est√© cargada antes del script de configuraci√≥n</li>';
            } else if (dataSource.includes('Local')) {
                html += '<li><strong>‚ö†Ô∏è Problema:</strong> Se est√°n cargando datos locales en lugar de BD</li>';
                html += '<li><strong>üîç Revisar:</strong> Logs de errores en consultas a la base de datos</li>';
                html += '<li><strong>üí° Posibles causas:</strong> Timeout, errores de columnas faltantes, o problemas de red</li>';
            } else if (dataSource.includes('Base de Datos')) {
                html += '<li><strong>‚úÖ Estado:</strong> Sistema funcionando correctamente</li>';
                html += '<li><strong>üìä Fuente:</strong> Datos cargados desde base de datos</li>';
            }
            
            if (hasErrors) {
                html += '<li><strong>üö® Errores encontrados:</strong></li>';
                capturedErrors.forEach(error => {
                    html += `<li style="margin-left: 20px;">‚Ä¢ ${error.message}</li>`;
                });
            }
            
            html += '</ul>';
            html += '<h4>üìã Logs recientes:</h4>';
            html += '<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">';
            
            const recentLogs = capturedLogs.slice(-10);
            recentLogs.forEach(log => {
                const color = log.type === 'error' ? 'red' : log.type === 'success' ? 'green' : log.type === 'warning' ? 'orange' : 'black';
                html += `<div style="color: ${color}">[${log.timestamp}] ${log.message}</div>`;
            });
            
            html += '</div>';
            recommendations.innerHTML = html;
            
            updateMetric('lastLogs', `${recentLogs.length} logs capturados`);
            updateMetric('recentErrors', hasErrors ? `${capturedErrors.length} errores` : 'Ninguno');
        }
        
        // Pruebas individuales
        async function testSupabaseInit() {
            showLoading(true);
            log('üöÄ PROBANDO INICIALIZACI√ìN DE SUPABASE...');
            
            try {
                log('üìã Estado actual del cliente:', !!supabaseClient);
                
                if (typeof initSupabase === 'function') {
                    const result = initSupabase();
                    log(`Resultado de inicializaci√≥n: ${result}`);
                    log(`Cliente despu√©s de init: ${!!supabaseClient}`);
                    
                    if (typeof debugSupabaseConnection === 'function') {
                        await debugSupabaseConnection();
                    }
                } else {
                    log('‚ùå Funci√≥n initSupabase no disponible', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function testDirectQuery() {
            showLoading(true);
            log('üì° PROBANDO QUERY DIRECTA...');
            
            try {
                if (!supabaseClient) {
                    log('‚ùå No hay cliente Supabase', 'error');
                    return;
                }
                
                log('üîÑ Ejecutando query directa...');
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('id, nombre, categoria')
                    .eq('activo', true)
                    .limit(5);
                
                if (error) {
                    log(`‚ùå Error en query: ${error.message}`, 'error');
                    log(`üìã C√≥digo: ${error.code}`, 'error');
                } else {
                    log(`‚úÖ Query exitosa: ${data.length} productos`, 'success');
                    data.forEach((producto, i) => {
                        log(`   ${i+1}. ${producto.nombre} (ID: ${producto.id})`);
                    });
                }
                
            } catch (error) {
                log(`‚ùå Excepci√≥n: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function forceLocalData() {
            showLoading(true);
            log('üìã FORZANDO CARGA DE DATOS LOCALES...');
            
            try {
                const localData = ProductosService.obtenerProductosLocales();
                log(`üì¶ Datos locales disponibles: ${localData.length} productos`, 'info');
                
                localData.slice(0, 3).forEach((producto, i) => {
                    log(`   ${i+1}. ${producto.nombre} (ID: ${producto.id})`);
                });
                
                log('‚ÑπÔ∏è Estos son los datos que se cargan cuando no hay conexi√≥n a BD', 'info');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Inicializaci√≥n autom√°tica
        document.addEventListener('DOMContentLoaded', async function() {
            log('üöÄ P√°gina de diagn√≥stico cargada');
            
            // Esperar un poco para que se carguen los scripts
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Verificaci√≥n r√°pida inicial
            const hasSupabase = typeof window.supabase !== 'undefined';
            const hasClient = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
            
            log(`üìã Estado inicial: Supabase=${hasSupabase}, Cliente=${hasClient}`);
            
            if (!hasSupabase) {
                log('‚ö†Ô∏è ALERTA: Librer√≠a Supabase no detectada', 'warning');
                updateStatus('supabaseStatus', 'error');
            }
            
            if (!hasClient && hasSupabase) {
                log('üîÑ Intentando inicializaci√≥n autom√°tica...');
                try {
                    initSupabase();
                    const newClient = typeof supabaseClient !== 'undefined' && supabaseClient !== null;
                    log(`Inicializaci√≥n autom√°tica: ${newClient ? '‚úÖ' : '‚ùå'}`, newClient ? 'success' : 'error');
                } catch (error) {
                    log(`‚ùå Error en inicializaci√≥n autom√°tica: ${error.message}`, 'error');
                }
            }
        });
    </script>
</body>
</html>
