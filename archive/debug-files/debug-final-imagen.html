<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Final - Carga de Imagen</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .log-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 11px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status-info {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .status-info.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status-info.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status-info.warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        .status-info.info { background: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Final - Carga de Imagen desde Archivo</h1>
        <p>Esta p√°gina simula exactamente el flujo del panel admin para identificar d√≥nde falla la carga de im√°genes.</p>

        <div class="debug-section">
            <h3>üìÑ Formulario Simplificado</h3>
            <form id="testForm">
                <div class="form-group">
                    <label for="nombre">Nombre del Producto:</label>
                    <input type="text" id="nombre" name="nombre" value="TEST Imagen Debug" required>
                </div>
                
                <div class="form-group">
                    <label for="imagen_file">Imagen (Archivo):</label>
                    <input type="file" id="imagen_file" name="imagen_file" accept="image/*" onchange="handleImageFile(this)">
                </div>
                
                <div id="imagePreview" style="display: none;">
                    <label>Vista Previa:</label>
                    <img id="previewImg" class="image-preview" alt="Preview">
                </div>
                
                <div class="button-grid">
                    <button type="button" onclick="debugStep1()">üîç 1. Debug Archivo</button>
                    <button type="button" onclick="debugStep2()">üìä 2. Verificar Estado</button>
                    <button type="button" onclick="debugStep3()">üì§ 3. Crear Producto</button>
                    <button type="button" onclick="resetAll()">üîÑ Resetear Todo</button>
                    <button type="button" onclick="clearLog()">üßπ Limpiar Log</button>
                    <button type="button" onclick="testConnection()">üîó Test Conexi√≥n</button>
                </div>
            </form>
        </div>

        <div class="debug-section">
            <h3>üìä Estado Actual</h3>
            <div id="currentState" class="status-info info">
                No hay archivo seleccionado...
            </div>
        </div>

        <div class="debug-section">
            <h3>üìù Log Detallado</h3>
            <div id="logOutput" class="log-output">Iniciando debug final de carga de imagen...\n</div>
        </div>
    </div>

    <!-- Scripts necesarios -->
    <script src="js/supabase-config.js"></script>
    
    <script>
        // Variables globales para simular AdminPanel
        let imageData = null;
        let imageType = 'url';
        let debugFile = null;
        
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ffff',
                'success': '#00ff00', 
                'warning': '#ffff00',
                'error': '#ff0000',
                'debug': '#ff00ff'
            };
            
            const coloredMessage = `[${timestamp}] ${message}\n`;
            logOutput.innerHTML += `<span style="color: ${colors[type] || '#00ffff'}">${coloredMessage}</span>`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = 'Log limpiado...\n';
        }
        
        function updateState(message, type = 'info') {
            const stateDiv = document.getElementById('currentState');
            stateDiv.className = `status-info ${type}`;
            stateDiv.innerHTML = message;
        }
        
        // PASO 1: Manejar archivo seleccionado (simula exactamente AdminPanel)
        function handleImageFile(input) {
            const file = input.files[0];
            debugFile = file;
            
            log('=== PASO 1: MANEJO DE ARCHIVO ===', 'debug');
            
            if (!file) {
                log('‚ùå No se seleccion√≥ archivo', 'error');
                imageData = null;
                imageType = 'url';
                updateState('Sin archivo seleccionado', 'error');
                return;
            }
            
            log(`üìÅ Archivo detectado: ${file.name}`, 'success');
            log(`   - Tama√±o: ${(file.size / 1024 / 1024).toFixed(2)}MB`, 'info');
            log(`   - Tipo: ${file.type}`, 'info');
            log(`   - √öltima modificaci√≥n: ${new Date(file.lastModified).toLocaleString()}`, 'info');
            
            // Validaciones (igual que AdminPanel)
            if (!file.type.startsWith('image/')) {
                log(`‚ùå Tipo de archivo inv√°lido: ${file.type}`, 'error');
                imageData = null;
                imageType = 'url';
                updateState('Tipo de archivo inv√°lido', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                log(`‚ùå Archivo muy grande: ${(file.size / 1024 / 1024).toFixed(2)}MB`, 'error');
                imageData = null;
                imageType = 'url';
                updateState('Archivo muy grande (>5MB)', 'error');
                return;
            }
            
            log('‚úÖ Validaciones pasadas, iniciando lectura...', 'success');
            updateState('Procesando archivo...', 'warning');
            
            // FileReader (exactamente como AdminPanel)
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const result = e.target.result;
                
                log('‚úÖ FileReader completado', 'success');
                log(`   - Tama√±o resultado: ${result.length} caracteres`, 'info');
                log(`   - Tipo de resultado: ${typeof result}`, 'info');
                log(`   - Prefijo: ${result.substring(0, 30)}...`, 'info');
                
                // Guardar datos (exactamente como AdminPanel)
                imageData = result;
                imageType = 'file';
                
                log('üìä Datos guardados en variables globales:', 'success');
                log(`   - imageData: ${imageData ? 'S√ç' : 'NO'}`, 'info');
                log(`   - imageType: ${imageType}`, 'info');
                
                // Mostrar preview
                const imagePreview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                
                if (previewImg) {
                    previewImg.src = result;
                    previewImg.alt = `Preview de ${file.name}`;
                    imagePreview.style.display = 'block';
                    log('üñºÔ∏è Preview mostrado', 'success');
                }
                
                updateState(`Archivo procesado: ${file.name} - Datos listos (${(result.length / 1024).toFixed(1)}KB)`, 'success');
                log('=== FIN PASO 1 ===', 'debug');
            };
            
            reader.onerror = () => {
                log('‚ùå Error en FileReader', 'error');
                imageData = null;
                imageType = 'url';
                updateState('Error leyendo archivo', 'error');
            };
            
            reader.readAsDataURL(file);
        }
        
        // PASO 2: Verificar estado antes del env√≠o
        function debugStep1() {
            log('=== DEBUG PASO 1: VERIFICACI√ìN DE ARCHIVO ===', 'debug');
            
            if (!debugFile) {
                log('‚ùå No hay archivo para debuggear', 'error');
                return;
            }
            
            log(`üìÅ Archivo actual: ${debugFile.name}`, 'info');
            log(`   - Tama√±o original: ${debugFile.size} bytes`, 'info');
            log(`   - Tipo MIME: ${debugFile.type}`, 'info');
            log(`   - V√°lido: ${debugFile.type.startsWith('image/') ? 'S√ç' : 'NO'}`, 'info');
            
            const input = document.getElementById('imagen_file');
            if (input && input.files && input.files[0]) {
                log('‚úÖ Input file todav√≠a tiene el archivo', 'success');
                log(`   - Nombre en input: ${input.files[0].name}`, 'info');
                log(`   - Igual al original: ${input.files[0] === debugFile ? 'S√ç' : 'NO'}`, 'info');
            } else {
                log('‚ùå Input file est√° vac√≠o', 'error');
            }
        }
        
        function debugStep2() {
            log('=== DEBUG PASO 2: VERIFICACI√ìN DE ESTADO ===', 'debug');
            
            log(`üìä Estado de variables globales:`, 'info');
            log(`   - imageData existe: ${imageData ? 'S√ç' : 'NO'}`, 'info');
            log(`   - imageType: "${imageType}"`, 'info');
            
            if (imageData) {
                log(`   - Tipo de imageData: ${typeof imageData}`, 'info');
                log(`   - Longitud: ${imageData.length}`, 'info');
                log(`   - Es data URL: ${imageData.startsWith('data:') ? 'S√ç' : 'NO'}`, 'info');
                log(`   - Es imagen: ${imageData.startsWith('data:image/') ? 'S√ç' : 'NO'}`, 'info');
                
                if (imageData.startsWith('data:image/')) {
                    const match = imageData.match(/^data:image\/([^;]+);base64,(.+)$/);
                    if (match) {
                        log(`   - Formato detectado: ${match[1]}`, 'success');
                        log(`   - Base64 puro (tama√±o): ${match[2].length} chars`, 'info');
                        log(`   - Base64 v√°lido: ${isValidBase64(match[2]) ? 'S√ç' : 'NO'}`, 'info');
                    } else {
                        log(`   - ‚ùå Formato de data URL inv√°lido`, 'error');
                    }
                }
            } else {
                log('‚ùå No hay datos de imagen', 'error');
            }
            
            // Verificar consistencia
            if (imageType === 'file' && !imageData) {
                log('‚ùå INCONSISTENCIA: tipo "file" pero sin datos', 'error');
                updateState('Error: Inconsistencia en datos de imagen', 'error');
            } else if (imageType === 'file' && imageData) {
                log('‚úÖ CONSISTENCIA: tipo "file" con datos v√°lidos', 'success');
                updateState('Estado consistente: Imagen lista para env√≠o', 'success');
            } else {
                log(`‚ö†Ô∏è Tipo "${imageType}" - verificar si es correcto`, 'warning');
            }
        }
        
        // PASO 3: Crear producto con m√°ximo logging
        async function debugStep3() {
            log('=== DEBUG PASO 3: CREACI√ìN DE PRODUCTO ===', 'debug');
            
            if (!imageData) {
                log('‚ùå No hay datos de imagen para enviar', 'error');
                updateState('Error: No hay imagen para crear producto', 'error');
                return;
            }
            
            if (imageType !== 'file') {
                log(`‚ö†Ô∏è Tipo de imagen no es "file": ${imageType}`, 'warning');
            }
            
            // Preparar datos exactamente como AdminPanel
            const formData = new FormData(document.getElementById('testForm'));
            const productData = {
                nombre: formData.get('nombre') || 'DEBUG TEST',
                marca: 'DEBUG MARCA',
                precio: 99999,
                categoria: 'para-ellos',
                imagen_url: imageData  // Aqu√≠ est√° la clave
            };
            
            log('üì¶ Datos preparados para env√≠o:', 'info');
            log(`   - nombre: "${productData.nombre}"`, 'info');
            log(`   - marca: "${productData.marca}"`, 'info');
            log(`   - precio: ${productData.precio}`, 'info');
            log(`   - categoria: "${productData.categoria}"`, 'info');
            log(`   - imagen_url: ${productData.imagen_url ? 'PRESENTE' : 'AUSENTE'}`, 'info');
            
            if (productData.imagen_url) {
                log(`   - imagen_url (tipo): ${typeof productData.imagen_url}`, 'info');
                log(`   - imagen_url (tama√±o): ${productData.imagen_url.length} chars`, 'info');
                log(`   - imagen_url (v√°lida): ${productData.imagen_url.startsWith('data:image/') ? 'S√ç' : 'NO'}`, 'info');
                log(`   - imagen_url (preview): ${productData.imagen_url.substring(0, 50)}...`, 'info');
            }
            
            try {
                log('üîÑ Llamando a ProductosService.crearProducto...', 'info');
                updateState('Enviando producto a Supabase...', 'warning');
                
                // Verificar que el servicio existe
                if (typeof ProductosService === 'undefined') {
                    throw new Error('ProductosService no est√° disponible');
                }
                
                if (typeof ProductosService.crearProducto !== 'function') {
                    throw new Error('ProductosService.crearProducto no es una funci√≥n');
                }
                
                // MOMENTO CR√çTICO: Llamada al servicio
                log('üì§ Enviando datos ahora...', 'success');
                const result = await ProductosService.crearProducto(productData);
                
                log('‚úÖ Producto creado exitosamente!', 'success');
                log(`   - ID del producto: ${result.id}`, 'success');
                log(`   - Datos devueltos:`, 'info');
                
                // Verificar qu√© devolvi√≥ Supabase
                Object.keys(result).forEach(key => {
                    const value = result[key];
                    if (key === 'imagen_url' || key === 'imagen') {
                        if (value) {
                            log(`   - ${key}: PRESENTE (${(value.length / 1024).toFixed(1)}KB)`, 'success');
                            log(`   - ${key} (tipo): ${typeof value}`, 'info');
                            log(`   - ${key} (v√°lida): ${value.startsWith('data:image/') ? 'S√ç' : 'NO'}`, 'info');
                        } else {
                            log(`   - ${key}: AUSENTE ‚ùå`, 'error');
                        }
                    } else {
                        log(`   - ${key}: ${value}`, 'info');
                    }
                });
                
                // Verificaci√≥n adicional: consultar el producto creado
                log('üîç Verificando producto en base de datos...', 'info');
                const verificacion = await ProductosService.obtenerProductoPorId(result.id);
                
                if (verificacion) {
                    log('‚úÖ Producto verificado en BD:', 'success');
                    if (verificacion.imagen_url) {
                        log(`   - Imagen en BD: S√ç (${(verificacion.imagen_url.length / 1024).toFixed(1)}KB)`, 'success');
                        log(`   - Imagen v√°lida en BD: ${verificacion.imagen_url.startsWith('data:image/') ? 'S√ç' : 'NO'}`, 'info');
                    } else {
                        log(`   - ‚ùå Imagen NO est√° en BD`, 'error');
                    }
                } else {
                    log('‚ùå No se pudo verificar el producto', 'error');
                }
                
                updateState(`Producto creado exitosamente! ID: ${result.id}`, 'success');
                
            } catch (error) {
                log('‚ùå ERROR en creaci√≥n de producto:', 'error');
                log(`   - Mensaje: ${error.message}`, 'error');
                log(`   - Tipo: ${error.constructor.name}`, 'error');
                
                if (error.stack) {
                    log(`   - Stack: ${error.stack}`, 'error');
                }
                
                if (error.details) {
                    log(`   - Detalles: ${error.details}`, 'error');
                }
                
                updateState(`Error: ${error.message}`, 'error');
            }
            
            log('=== FIN DEBUG PASO 3 ===', 'debug');
        }
        
        function resetAll() {
            imageData = null;
            imageType = 'url';
            debugFile = null;
            
            document.getElementById('testForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            updateState('Todo reseteado', 'info');
            log('üîÑ Estado completamente reseteado', 'info');
        }
        
        async function testConnection() {
            log('=== TEST DE CONEXI√ìN ===', 'debug');
            
            try {
                if (typeof ProductosService === 'undefined') {
                    throw new Error('ProductosService no disponible');
                }
                
                log('‚úÖ ProductosService disponible', 'success');
                
                // Test b√°sico de conexi√≥n
                const productos = await ProductosService.obtenerProductos();
                log(`‚úÖ Conexi√≥n exitosa - ${productos.length} productos en BD`, 'success');
                
                updateState(`Conexi√≥n OK - ${productos.length} productos encontrados`, 'success');
                
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                updateState(`Error de conexi√≥n: ${error.message}`, 'error');
            }
            
            log('=== FIN TEST CONEXI√ìN ===', 'debug');
        }
        
        // Utilidad para validar base64
        function isValidBase64(str) {
            try {
                return btoa(atob(str)) === str;
            } catch (err) {
                return false;
            }
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Debug final iniciado', 'success');
            updateState('Listo para debugging - Selecciona un archivo', 'info');
        });
    </script>
</body>
</html>
