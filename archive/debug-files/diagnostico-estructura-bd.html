<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Estructura de Base de Datos</title>
    <link rel="stylesheet" href="css/admin-panel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .diagnostic-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .diagnostic-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid rgba(184,134,11,0.2);
            border-radius: 8px;
            background: rgba(245,245,240,0.3);
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .column-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .column-table th,
        .column-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .column-table th {
            background: var(--color-gold);
            color: white;
            font-weight: 600;
        }
        .column-table tr:hover {
            background: rgba(184,134,11,0.1);
        }
    </style>
</head>
<body>
    <!-- Importar dependencias -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <div class="diagnostic-container">
        <h1 class="section-title">üîç Diagn√≥stico de Base de Datos</h1>
        <p>Esta herramienta verifica la estructura actual de la tabla productos en Supabase.</p>

        <!-- Estado de conexi√≥n -->
        <div class="diagnostic-section">
            <h2 class="test-title">üîó Estado de Conexi√≥n</h2>
            <div id="connection-status">Verificando...</div>
            <button onclick="checkConnection()" class="btn btn-primary">
                <i class="fas fa-wifi"></i> Verificar Conexi√≥n
            </button>
        </div>

        <!-- Estructura de la tabla -->
        <div class="diagnostic-section">
            <h2 class="test-title">üìã Estructura de Tabla 'productos'</h2>
            <div id="table-structure">Listo para verificar</div>
            <button onclick="checkTableStructure()" class="btn btn-primary">
                <i class="fas fa-table"></i> Analizar Estructura
            </button>
        </div>

        <!-- Verificar columnas espec√≠ficas -->
        <div class="diagnostic-section">
            <h2 class="test-title">üéØ Verificar Columnas Espec√≠ficas</h2>
            <div id="column-check">Listo para verificar</div>
            <button onclick="checkSpecificColumns()" class="btn btn-primary">
                <i class="fas fa-search"></i> Verificar Columnas
            </button>
        </div>

        <!-- Test de productos -->
        <div class="diagnostic-section">
            <h2 class="test-title">üì¶ Test de Productos</h2>
            <div id="products-test">Listo para ejecutar</div>
            <button onclick="testProducts()" class="btn btn-primary">
                <i class="fas fa-box"></i> Probar Consulta
            </button>
        </div>

        <!-- Script SQL recomendado -->
        <div class="diagnostic-section">
            <h2 class="test-title">üõ†Ô∏è Script SQL Recomendado</h2>
            <p>Si faltan las columnas <code>estado</code> y <code>descuento</code>, ejecuta este script en el SQL Editor de Supabase:</p>
            <div class="code-block" id="sql-script">-- Script para agregar columnas faltantes
-- Copiar y pegar en el SQL Editor de Supabase

-- Agregar columna 'estado'
ALTER TABLE productos ADD COLUMN IF NOT EXISTS estado varchar(20) DEFAULT 'disponible';
ALTER TABLE productos ADD CONSTRAINT IF NOT EXISTS productos_estado_check 
CHECK (estado IN ('disponible', 'agotado', 'proximo', 'oferta'));

-- Agregar columna 'descuento'
ALTER TABLE productos ADD COLUMN IF NOT EXISTS descuento integer;
ALTER TABLE productos ADD CONSTRAINT IF NOT EXISTS productos_descuento_check 
CHECK (descuento IS NULL OR (descuento >= 1 AND descuento <= 99));

-- Actualizar productos existentes
UPDATE productos SET estado = 'disponible' WHERE estado IS NULL;</div>
            <button onclick="copySQL()" class="btn btn-secondary">
                <i class="fas fa-copy"></i> Copiar SQL
            </button>
        </div>

        <!-- Logs -->
        <div class="diagnostic-section">
            <h2 class="test-title">üìã Logs de Diagn√≥stico</h2>
            <pre id="diagnostic-logs" class="code-block" style="max-height: 300px; overflow-y: auto;"></pre>
            <button onclick="clearLogs()" class="btn btn-secondary">
                <i class="fas fa-trash"></i> Limpiar Logs
            </button>
        </div>
    </div>

    <script>
        let supabaseInitialized = false;

        // Funci√≥n para agregar logs
        function addLog(message, type = 'info') {
            const logs = document.getElementById('diagnostic-logs');
            const timestamp = new Date().toLocaleTimeString();
            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';
            
            logs.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('diagnostic-logs').textContent = '';
        }

        // Verificar conexi√≥n
        async function checkConnection() {
            const status = document.getElementById('connection-status');
            status.innerHTML = 'Verificando conexi√≥n...';
            
            try {
                addLog('Iniciando verificaci√≥n de conexi√≥n...', 'info');
                
                // Verificar si Supabase est√° disponible
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase JS no est√° cargado');
                }
                
                // Inicializar si no est√° inicializado
                if (!supabaseInitialized) {
                    const initialized = initSupabase();
                    if (!initialized) {
                        throw new Error('No se pudo inicializar Supabase');
                    }
                    supabaseInitialized = true;
                    addLog('Supabase inicializado correctamente', 'success');
                }
                
                // Test de conexi√≥n simple
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    throw new Error(`Error de conexi√≥n: ${error.message}`);
                }
                
                status.innerHTML = '<span class="success">‚úÖ Conexi√≥n exitosa a Supabase</span>';
                addLog('Conexi√≥n a Supabase verificada exitosamente', 'success');
                
            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Verificar estructura de tabla
        async function checkTableStructure() {
            const result = document.getElementById('table-structure');
            result.innerHTML = 'Analizando estructura...';
            
            try {
                addLog('Obteniendo estructura de la tabla productos...', 'info');
                
                if (!supabaseInitialized) {
                    await checkConnection();
                }
                
                // Obtener informaci√≥n de las columnas (m√©todo alternativo)
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    throw new Error(`Error consultando tabla: ${error.message}`);
                }
                
                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    
                    let tableHTML = '<table class="column-table"><thead><tr><th>Columna</th><th>Estado</th></tr></thead><tbody>';
                    
                    const expectedColumns = ['id', 'nombre', 'marca', 'precio', 'categoria', 'descripcion', 'imagen_url', 'estado', 'descuento', 'activo'];
                    
                    expectedColumns.forEach(col => {
                        const exists = columns.includes(col);
                        const status = exists ? '<span class="success">‚úÖ Existe</span>' : '<span class="error">‚ùå Falta</span>';
                        tableHTML += `<tr><td>${col}</td><td>${status}</td></tr>`;
                        addLog(`Columna '${col}': ${exists ? 'existe' : 'falta'}`, exists ? 'success' : 'warning');
                    });
                    
                    tableHTML += '</tbody></table>';
                    
                    result.innerHTML = tableHTML;
                    addLog(`Estructura analizada: ${columns.length} columnas encontradas`, 'info');
                    
                } else {
                    result.innerHTML = '<span class="warning">‚ö†Ô∏è No hay datos en la tabla</span>';
                    addLog('La tabla productos est√° vac√≠a', 'warning');
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error analizando estructura: ${error.message}`, 'error');
            }
        }

        // Verificar columnas espec√≠ficas
        async function checkSpecificColumns() {
            const result = document.getElementById('column-check');
            result.innerHTML = 'Verificando columnas...';
            
            try {
                addLog('Verificando columnas estado y descuento...', 'info');
                
                if (!supabaseInitialized) {
                    await checkConnection();
                }
                
                const tests = [];
                
                // Test 1: Intentar actualizar con estado
                try {
                    const { error: estadoError } = await supabaseClient
                        .from('productos')
                        .update({ estado: 'disponible' })
                        .eq('id', -1); // ID que no existe
                    
                    if (estadoError && estadoError.message.includes('estado')) {
                        tests.push({ column: 'estado', exists: false, error: estadoError.message });
                        addLog('Columna estado: NO EXISTE', 'error');
                    } else {
                        tests.push({ column: 'estado', exists: true });
                        addLog('Columna estado: EXISTE', 'success');
                    }
                } catch (error) {
                    tests.push({ column: 'estado', exists: false, error: error.message });
                    addLog(`Columna estado: ERROR - ${error.message}`, 'error');
                }
                
                // Test 2: Intentar actualizar con descuento
                try {
                    const { error: descuentoError } = await supabaseClient
                        .from('productos')
                        .update({ descuento: 10 })
                        .eq('id', -1); // ID que no existe
                    
                    if (descuentoError && descuentoError.message.includes('descuento')) {
                        tests.push({ column: 'descuento', exists: false, error: descuentoError.message });
                        addLog('Columna descuento: NO EXISTE', 'error');
                    } else {
                        tests.push({ column: 'descuento', exists: true });
                        addLog('Columna descuento: EXISTE', 'success');
                    }
                } catch (error) {
                    tests.push({ column: 'descuento', exists: false, error: error.message });
                    addLog(`Columna descuento: ERROR - ${error.message}`, 'error');
                }
                
                // Mostrar resultados
                let resultHTML = '<div>';
                tests.forEach(test => {
                    const status = test.exists ? 
                        '<span class="success">‚úÖ Existe</span>' : 
                        '<span class="error">‚ùå Falta</span>';
                    resultHTML += `<p><strong>${test.column}:</strong> ${status}</p>`;
                    if (test.error) {
                        resultHTML += `<small style="color: #666;">${test.error}</small>`;
                    }
                });
                resultHTML += '</div>';
                
                result.innerHTML = resultHTML;
                
                const missingColumns = tests.filter(t => !t.exists);
                if (missingColumns.length > 0) {
                    addLog(`Faltan ${missingColumns.length} columnas. Ejecuta el script SQL.`, 'warning');
                } else {
                    addLog('Todas las columnas necesarias existen', 'success');
                }
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error verificando columnas: ${error.message}`, 'error');
            }
        }

        // Test de productos
        async function testProducts() {
            const result = document.getElementById('products-test');
            result.innerHTML = 'Probando consulta...';
            
            try {
                addLog('Ejecutando consulta de prueba a productos...', 'info');
                
                if (!supabaseInitialized) {
                    await checkConnection();
                }
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('id, nombre, marca, precio, categoria, estado, descuento')
                    .limit(5);
                
                if (error) {
                    throw new Error(`Error en consulta: ${error.message}`);
                }
                
                result.innerHTML = `
                    <div class="success">‚úÖ Consulta exitosa</div>
                    <p><strong>Productos encontrados:</strong> ${data.length}</p>
                    <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                `;
                
                addLog(`Consulta exitosa: ${data.length} productos obtenidos`, 'success');
                
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                addLog(`Error en consulta de productos: ${error.message}`, 'error');
            }
        }

        // Copiar SQL
        function copySQL() {
            const sqlText = document.getElementById('sql-script').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                addLog('Script SQL copiado al portapapeles', 'success');
                alert('Script SQL copiado al portapapeles');
            }).catch(err => {
                addLog('Error copiando al portapapeles', 'error');
                alert('Error copiando al portapapeles');
            });
        }

        // Auto-inicializar
        window.addEventListener('load', () => {
            addLog('Diagn√≥stico iniciado', 'info');
            addLog('Haz clic en "Verificar Conexi√≥n" para empezar', 'info');
        });
    </script>
</body>
</html>
