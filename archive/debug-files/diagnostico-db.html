<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Base de Datos</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; line-height: 1.6; }
        .section { border: 1px solid #ddd; margin: 1rem 0; padding: 1rem; border-radius: 8px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button { padding: 0.5rem 1rem; margin: 0.5rem; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico de Base de Datos - Productos</h1>
    
    <div class="section">
        <h2>1. Conexi√≥n a Supabase</h2>
        <div id="connectionStatus">Verificando...</div>
        <button onclick="testConnection()">Probar Conexi√≥n</button>
    </div>
    
    <div class="section">
        <h2>2. Estructura de Tabla 'productos'</h2>
        <div id="tableStructure">Verificando...</div>
        <button onclick="checkTableStructure()">Verificar Estructura</button>
    </div>
    
    <div class="section">
        <h2>3. Test de Inserci√≥n</h2>
        <div id="insertTest">Listo para probar...</div>
        <button onclick="testInsert()">Probar Inserci√≥n</button>
    </div>
    
    <div class="section">
        <h2>4. Datos Existentes</h2>
        <div id="existingData">Cargando...</div>
        <button onclick="loadExistingData()">Cargar Datos</button>
    </div>
      <div class="section">
        <h2>5. Script SQL Recomendado</h2>
        <div id="sqlScript">
            <p class="info">üí° Script para agregar TODAS las columnas necesarias:</p>
            <pre><code>-- Agregar columnas faltantes
ALTER TABLE productos ADD COLUMN IF NOT EXISTS subcategoria TEXT;
ALTER TABLE productos ADD COLUMN IF NOT EXISTS descripcion TEXT;
ALTER TABLE productos ADD COLUMN IF NOT EXISTS notas TEXT;
ALTER TABLE productos ADD COLUMN IF NOT EXISTS imagen TEXT;
ALTER TABLE productos ADD COLUMN IF NOT EXISTS imagen_url TEXT;
ALTER TABLE productos ADD COLUMN IF NOT EXISTS activo BOOLEAN DEFAULT true;

-- Verificar cambios
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'productos';</code></pre>
            <p class="warning">‚ö†Ô∏è O usa el archivo: <strong>setup-productos-completo.sql</strong> para una configuraci√≥n completa</p>
        </div>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        let connectionResult = null;
        
        window.addEventListener('DOMContentLoaded', async () => {
            await testConnection();
            await checkTableStructure();
            await loadExistingData();
        });

        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            
            try {
                if (typeof initSupabase === 'function') {
                    const initialized = initSupabase();
                    if (!initialized) {
                        statusDiv.innerHTML = '<p class="error">‚ùå Error inicializando Supabase</p>';
                        return;
                    }
                }
                
                if (typeof testSupabaseConnection === 'function') {
                    const connected = await testSupabaseConnection();
                    if (connected) {
                        statusDiv.innerHTML = '<p class="success">‚úÖ Conexi√≥n exitosa a Supabase</p>';
                        connectionResult = true;
                    } else {
                        statusDiv.innerHTML = '<p class="error">‚ùå Error de conexi√≥n a Supabase</p>';
                        connectionResult = false;
                    }
                } else {
                    statusDiv.innerHTML = '<p class="warning">‚ö†Ô∏è Funci√≥n de test no disponible, intentando conexi√≥n directa...</p>';
                    
                    // Test directo
                    if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                        try {
                            const { data, error } = await supabaseClient.from('productos').select('count').limit(1);
                            if (error) throw error;
                            statusDiv.innerHTML = '<p class="success">‚úÖ Conexi√≥n directa exitosa</p>';
                            connectionResult = true;
                        } catch (error) {
                            statusDiv.innerHTML = `<p class="error">‚ùå Error conexi√≥n directa: ${error.message}</p>`;
                            connectionResult = false;
                        }
                    }
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                connectionResult = false;
            }
        }

        async function checkTableStructure() {
            const structureDiv = document.getElementById('tableStructure');
            
            if (!connectionResult) {
                structureDiv.innerHTML = '<p class="error">‚ùå Primero resuelve la conexi√≥n a Supabase</p>';
                return;
            }
            
            try {
                // Intentar obtener informaci√≥n de columnas
                const { data, error } = await supabaseClient
                    .rpc('get_columns_info', { table_name: 'productos' });
                    
                if (error) {
                    // M√©todo alternativo - consulta vac√≠a para ver qu√© columnas acepta
                    console.log('Intentando m√©todo alternativo...');
                    
                    const { data: emptyData, error: emptyError } = await supabaseClient
                        .from('productos')
                        .select('*')
                        .limit(1);
                        
                    if (emptyError) {
                        structureDiv.innerHTML = `<p class="error">‚ùå Error accediendo tabla: ${emptyError.message}</p>`;
                        return;
                    }
                      if (emptyData && emptyData.length > 0) {
                        const columns = Object.keys(emptyData[0]);
                        let tableHTML = '<table><tr><th>Columna</th><th>Estado</th><th>Tipo</th></tr>';
                        
                        // Columnas requeridas para el panel
                        const requiredColumns = ['nombre', 'marca', 'precio', 'categoria', 'subcategoria', 'descripcion', 'notas', 'imagen', 'imagen_url', 'activo'];
                        
                        requiredColumns.forEach(col => {
                            const exists = columns.includes(col);
                            const status = exists ? '‚úÖ Existe' : '‚ùå Falta';
                            const statusClass = exists ? 'success' : 'error';
                            const type = exists ? typeof emptyData[0][col] : 'N/A';
                            tableHTML += `<tr><td>${col}</td><td class="${statusClass}">${status}</td><td>${type}</td></tr>`;
                        });
                        tableHTML += '</table>';
                        
                        const missingColumns = requiredColumns.filter(col => !columns.includes(col));
                        
                        structureDiv.innerHTML = `
                            <p class="success">‚úÖ Tabla accesible. An√°lisis de columnas:</p>
                            ${tableHTML}
                            ${missingColumns.length > 0 ? 
                                `<p class="error">‚ùå Faltan ${missingColumns.length} columnas: ${missingColumns.join(', ')}</p>
                                 <p class="warning">‚ö†Ô∏è Ejecuta el script SQL recomendado para agregar las columnas faltantes</p>` : 
                                '<p class="success">‚úÖ Todas las columnas necesarias est√°n presentes</p>'
                            }
                        `;
                    } else {
                        structureDiv.innerHTML = '<p class="warning">‚ö†Ô∏è Tabla vac√≠a, no se puede determinar estructura</p>';
                    }
                } else {
                    structureDiv.innerHTML = `<p class="success">‚úÖ Estructura obtenida: <pre>${JSON.stringify(data, null, 2)}</pre></p>`;
                }
                
            } catch (error) {
                structureDiv.innerHTML = `<p class="error">‚ùå Error verificando estructura: ${error.message}</p>`;
            }
        }        async function testInsert() {
            const testDiv = document.getElementById('insertTest');
            
            if (!connectionResult) {
                testDiv.innerHTML = '<p class="error">‚ùå Primero resuelve la conexi√≥n</p>';
                return;
            }
            
            try {
                // Test 1: Datos m√≠nimos requeridos
                testDiv.innerHTML = '<p class="info">üîÑ Test 1: Probando con datos m√≠nimos...</p>';
                
                const testProductMinimal = {
                    nombre: 'Test M√≠nimo',
                    marca: 'Test Brand',
                    precio: 50000,
                    categoria: 'para-ellos'
                };
                
                const { data: minData, error: minError } = await supabaseClient
                    .from('productos')
                    .insert([testProductMinimal])
                    .select()
                    .single();
                    
                if (minError) {
                    testDiv.innerHTML += `<p class="error">‚ùå Error con datos m√≠nimos: ${minError.message}</p>`;
                } else {
                    testDiv.innerHTML += `<p class="success">‚úÖ Datos m√≠nimos OK. ID: ${minData.id}</p>`;
                    
                    // Test 2: Datos completos
                    testDiv.innerHTML += '<p class="info">üîÑ Test 2: Probando con datos completos...</p>';
                    
                    const testProductComplete = {
                        nombre: 'Test Completo',
                        marca: 'Test Brand Complete',
                        precio: 75000,
                        categoria: 'para-ellas',
                        subcategoria: 'designer',
                        descripcion: 'Producto de prueba completo',
                        notas: 'Notas de prueba',
                        imagen_url: 'https://via.placeholder.com/300',
                        activo: true
                    };
                    
                    const { data: compData, error: compError } = await supabaseClient
                        .from('productos')
                        .insert([testProductComplete])
                        .select()
                        .single();
                        
                    if (compError) {
                        testDiv.innerHTML += `<p class="warning">‚ö†Ô∏è Error con datos completos: ${compError.message}</p>`;
                        testDiv.innerHTML += '<p class="info">üí° Algunas columnas no existen. Usa el script SQL recomendado.</p>';
                    } else {
                        testDiv.innerHTML += `<p class="success">‚úÖ Datos completos OK. ID: ${compData.id}</p>`;
                    }
                }
                
            } catch (error) {
                testDiv.innerHTML += `<p class="error">‚ùå Error general: ${error.message}</p>`;
            }
        }

        async function loadExistingData() {
            const dataDiv = document.getElementById('existingData');
            
            if (!connectionResult) {
                dataDiv.innerHTML = '<p class="error">‚ùå Primero resuelve la conexi√≥n</p>';
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*')
                    .limit(5);
                    
                if (error) {
                    dataDiv.innerHTML = `<p class="error">‚ùå Error cargando datos: ${error.message}</p>`;
                    return;
                }
                
                if (data.length === 0) {
                    dataDiv.innerHTML = '<p class="warning">‚ö†Ô∏è No hay productos en la base de datos</p>';
                    return;
                }
                
                let tableHTML = '<table><tr>';
                const columns = Object.keys(data[0]);
                columns.forEach(col => {
                    tableHTML += `<th>${col}</th>`;
                });
                tableHTML += '</tr>';
                
                data.forEach(row => {
                    tableHTML += '<tr>';
                    columns.forEach(col => {
                        const value = row[col];
                        const displayValue = value ? (typeof value === 'string' && value.length > 50 ? value.substring(0, 50) + '...' : value) : 'null';
                        tableHTML += `<td>${displayValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</table>';
                
                dataDiv.innerHTML = `
                    <p class="success">‚úÖ ${data.length} productos encontrados:</p>
                    ${tableHTML}
                `;
                
            } catch (error) {
                dataDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
